
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <title>LinkedList&#39;s Blog</title>
        <meta name="author" content="Ding Li" />
        <meta name="description" content="This is blog for Linkedlist771, mainly record some learning notes, thank you for your visit!" />
        <meta name="keywords" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <link rel="icon" href="/images/favicon.png" />
        <script src="https://cdn.staticfile.org/vue/3.2.47/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.3.0/css/all.min.css" />
<link rel="stylesheet" href="/css/fonts.min.css" />
<script> const mixins = {}; </script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://cdn.staticfile.org/KaTeX/0.16.4/katex.min.js"></script>
<script src="https://cdn.staticfile.org/KaTeX/0.16.4/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.16.4/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>





<script src="/js/lib/home.js"></script>

<link rel="stylesheet" href="/css/main.css" />

    <meta name="generator" content="Hexo 6.3.0"></head>
    <body>
        <div id="layout">
            <transition name="fade">
                <div id="loading" v-show="loading">
                    <div id="loading-circle">
                        <h2>LOADING</h2>
                        <p>加载过慢请开启缓存 浏览器默认开启</p>
                        <img src="/images/loading.gif" />
                    </div>
                </div>
            </transition>
            <nav id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <div id="desktop-menu">
        <a class="title" href="/">
            <span>LINKEDLIST&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;LINKEDLIST&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </div>
</nav>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

            <transition name="into">
                <div id="main" v-show="!loading">
                    <div id="home-head">
    <div id="home-background" ref="homeBackground" data-images="/images/background1.jpg"></div>
    <div id="home-info" @click="homeClick">
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="info">
            <div class="wrap">
                <h1>LinkedList&#39;s Blog</h1>
                <h3>Learning notes</h3>
                <h5>This is blog for Linkedlist771, mainly record some learning notes, thank you for your visit!</h5>
            </div>
        </span>
    </div>
</div>
<div id="home-posts-wrap"  ref="homePostsWrap">
    <div id="home-posts">
        

<div class="post">
    <a href="/2023/08/05/%E9%AB%98%E7%BA%A7python%E7%9F%A5%E8%AF%86/">
        <h2 class="post-title">高级python知识</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/8/5
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            
            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/08/05/%E9%AB%98%E7%BA%A7python%E7%9F%A5%E8%AF%86/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/24/docker%E5%AD%A6%E4%B9%A0/">
        <h2 class="post-title">docker学习</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/24
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <h3 id="什么是docker"><a href="#什么是docker" class="headerlink" title="什么是docker"></a>什么是docker</h3><blockquote>
<p>Simply put, a container is a sandboxed process on your machine that is isolated from all other processes on the host machine. That isolation leverages <a target="_blank" rel="noopener" href="https://medium.com/@saschagrunert/demystifying-containers-part-i-kernel-space-2c53d6979504">kernel namespaces and cgroups</a>, features that have been in Linux for a long time. Docker has worked to make these capabilities approachable and easy to use. To summarize, a container:</p>
<ul>
<li>Is a runnable instance of an image. You can create, start, stop, move, or delete a container using the DockerAPI or CLI.</li>
<li>Can be run on local machines, virtual machines or deployed to the cloud.</li>
<li>Is portable (can be run on any OS).</li>
<li>Is isolated from other containers and runs its own software, binaries, and configurations.</li>
</ul>
</blockquote>
<h3 id="什么是Image"><a href="#什么是Image" class="headerlink" title="什么是Image"></a>什么是Image</h3><blockquote>
<p>When running a container, it uses an isolated filesystem. This custom filesystem is provided by a container image. Since the image contains the container’s filesystem, it must contain everything needed to run an application - all dependencies, configurations, scripts, binaries, etc. The image also contains other configuration for the container, such as environment variables, a default command to run, and other metadata.</p>
</blockquote>
<h3 id="下载安装docker"><a href="#下载安装docker" class="headerlink" title="下载安装docker"></a>下载安装docker</h3><p><a target="_blank" rel="noopener" href="https://docs.docker.com/get-docker/">Get Docker | Docker Documentation</a></p>
<h3 id="创建部署docker"><a href="#创建部署docker" class="headerlink" title="创建部署docker"></a>创建部署docker</h3><ul>
<li><p>Create an empty file named <code>Dockerfile</code>.</p>
<pre><code class="bash">type nul &gt; Dockerfile
</code></pre>
</li>
</ul>
<h2 id="Ubuntu部署docker"><a href="#Ubuntu部署docker" class="headerlink" title="Ubuntu部署docker"></a>Ubuntu部署docker</h2><h3 id="卸载docker"><a href="#卸载docker" class="headerlink" title="卸载docker"></a>卸载docker</h3><pre><code class="bash">sudo apt remove docker-desktop
</code></pre>
<h2 id="更新包"><a href="#更新包" class="headerlink" title="更新包"></a>更新包</h2><p>Update the <code>apt</code> package index and install packages to allow <code>apt</code> to use a repository over HTTPS:</p>
<p>容器的运行环境是隔离的</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/24/docker%E5%AD%A6%E4%B9%A0/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/23/%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE/">
        <h2 class="post-title"></h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/23
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <h4 id="下载项目"><a href="#下载项目" class="headerlink" title="下载项目"></a>下载项目</h4><pre><code class="bash">git clone git@github.com:RVC-Project/Retrieval-based-Voice-Conversion-WebUI.git
</code></pre>
<h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><pre><code class="bash">conda create -n SVC python=3.9
pip install -r requirements.txt
</code></pre>
<h4 id="下载对应的配置环境"><a href="#下载对应的配置环境" class="headerlink" title="下载对应的配置环境"></a>下载对应的配置环境</h4><p><a target="_blank" rel="noopener" href="https://huggingface.co/lj1995/VoiceConversionWebUI/tree/main">lj1995&#x2F;VoiceConversionWebUI at main (huggingface.co)</a></p>
<p><img src="/.com//Users\23174\AppData\Roaming\Typora\typora-user-images\image-20230723155912006.png" alt="image-20230723155912006"></p>
<p><img src="/.com//Users\23174\AppData\Roaming\Typora\typora-user-images\image-20230723155937470.png" alt="image-20230723155937470"></p>
<p><img src="/.com//Users\23174\AppData\Roaming\Typora\typora-user-images\image-20230723155959215.png" alt="image-20230723155959215"></p>
<p>将这些文件配置在对应的路径中：</p>
<pre><code class="bash">hubert_base.pt

./pretrained 

./uvr5_weights

想测试v2版本模型的话，需要额外下载

./pretrained_v2 

如果你正在使用Windows，则你可能需要这个文件，若ffmpeg和ffprobe已安装则跳过; ubuntu/debian 用户可以通过apt install ffmpeg来安装这2个库

./ffmpeg

https://huggingface.co/lj1995/VoiceConversionWebUI/blob/main/ffmpeg.exe

./ffprobe

https://huggingface.co/lj1995/VoiceConversionWebUI/blob/main/ffprobe.exe

如果你想使用最新的RMVPE人声音高提取算法，则你需要下载音高提取模型参数并放置于RVC根目录

https://huggingface.co/lj1995/VoiceConversionWebUI/blob/main/rmvpe.pt
</code></pre>
<p>然后启动<code>infer-web.py</code> 来运行webui。</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/23/%E4%B8%8B%E8%BD%BD%E9%A1%B9%E7%9B%AE/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/22/ControlNet%20for%20Stable%20Diffusion%20WebUI/">
        <h2 class="post-title"></h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/22
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <h1 id="ControlNet-for-Stable-Diffusion-WebUI"><a href="#ControlNet-for-Stable-Diffusion-WebUI" class="headerlink" title="ControlNet for Stable Diffusion WebUI"></a>ControlNet for Stable Diffusion WebUI</h1><p>The WebUI extension for ControlNet and other injection-based SD controls.</p>
<p><img src="https://user-images.githubusercontent.com/19834515/235606305-229b3d1e-5bfc-467f-9d55-0976eab71652.png" alt="image"></p>
<p>This extension is for AUTOMATIC1111’s <a target="_blank" rel="noopener" href="https://github.com/AUTOMATIC1111/stable-diffusion-webui">Stable Diffusion web UI</a>, allows the Web UI to add <a target="_blank" rel="noopener" href="https://github.com/lllyasviel/ControlNet">ControlNet</a> to the original Stable Diffusion model to generate images. The addition is on-the-fly, the merging is not required.</p>
<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><ol>
<li>Open “Extensions” tab.</li>
<li>Open “Install from URL” tab in the tab.</li>
<li>Enter <code>https://github.com/Mikubill/sd-webui-controlnet.git</code> to “URL for extension’s git repository”.</li>
<li>Press “Install” button.</li>
<li>Wait for 5 seconds, and you will see the message “Installed into stable-diffusion-webui\extensions\sd-webui-controlnet. Use Installed tab to restart”.</li>
<li>Go to “Installed” tab, click “Check for updates”, and then click “Apply and restart UI”. (The next time you can also use these buttons to update ControlNet.)</li>
<li>Completely restart A1111 webui including your terminal. (If you do not know what is a “terminal”, you can reboot your computer to achieve the same effect.)</li>
<li>Download models (see below).</li>
<li>After you put models in the correct folder, you may need to refresh to see the models. The refresh button is right to your “Model” dropdown.</li>
</ol>
<p><strong>Update from ControlNet 1.0 to 1.1:</strong></p>
<ul>
<li><p>If you are not sure, you can back up and remove the folder “stable-diffusion-webui\extensions\sd-webui-controlnet”, and then start from the step 1 in the above Installation section. </p>
</li>
<li><p>Or you can start from the step 6 in the above Install section.</p>
</li>
</ul>
<h1 id="Download-Models"><a href="#Download-Models" class="headerlink" title="Download Models"></a>Download Models</h1><p>Right now all the 14 models of ControlNet 1.1 are in the beta test.</p>
<p>Download the models from ControlNet 1.1: <a target="_blank" rel="noopener" href="https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main">https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main</a></p>
<p>You need to download model files ending with “.pth” .</p>
<p>Put models in your “stable-diffusion-webui\extensions\sd-webui-controlnet\models”. Now we have already included all “yaml” files. You only need to download “pth” files.</p>
<p>Do not right-click the filenames in HuggingFace website to download. Some users right-clicked those HuggingFace HTML websites and saved those HTML pages as PTH&#x2F;YAML files. They are not downloading correct files. Instead, please click the small download arrow “↓” icon in HuggingFace to download.</p>
<p>Note: If you download models elsewhere, please make sure that yaml file names and model files names are same. Please manually rename all yaml files if you download from other sources. (Some models like “shuffle” needs the yaml file so that we know the outputs of ControlNet should pass a global average pooling before injecting to SD U-Nets.)</p>
<h1 id="New-Features-in-ControlNet-1-1"><a href="#New-Features-in-ControlNet-1-1" class="headerlink" title="New Features in ControlNet 1.1"></a>New Features in ControlNet 1.1</h1><h3 id="Perfect-Support-for-All-ControlNet-1-0-x2F-1-1-and-T2I-Adapter-Models"><a href="#Perfect-Support-for-All-ControlNet-1-0-x2F-1-1-and-T2I-Adapter-Models" class="headerlink" title="Perfect Support for All ControlNet 1.0&#x2F;1.1 and T2I Adapter Models."></a>Perfect Support for All ControlNet 1.0&#x2F;1.1 and T2I Adapter Models.</h3><p>Now we have perfect support all available models and preprocessors, including perfect support for T2I style adapter and ControlNet 1.1 Shuffle. (Make sure that your YAML file names and model file names are same, see also YAML files in “stable-diffusion-webui\extensions\sd-webui-controlnet\models”.)</p>
<h3 id="Perfect-Support-for-A1111-High-Res-Fix"><a href="#Perfect-Support-for-A1111-High-Res-Fix" class="headerlink" title="Perfect Support for A1111 High-Res. Fix"></a>Perfect Support for A1111 High-Res. Fix</h3><p>Now if you turn on High-Res Fix in A1111, each controlnet will output two different control images: a small one and a large one. The small one is for your basic generating, and the big one is for your High-Res Fix generating. The two control images are computed by a smart algorithm called “super high-quality control image resampling”. This is turned on by default, and you do not need to change any setting.</p>
<h3 id="Perfect-Support-for-All-A1111-Img2Img-or-Inpaint-Settings-and-All-Mask-Types"><a href="#Perfect-Support-for-All-A1111-Img2Img-or-Inpaint-Settings-and-All-Mask-Types" class="headerlink" title="Perfect Support for All A1111 Img2Img or Inpaint Settings and All Mask Types"></a>Perfect Support for All A1111 Img2Img or Inpaint Settings and All Mask Types</h3><p>Now ControlNet is extensively tested with A1111’s different types of masks, including “Inpaint masked”&#x2F;“Inpaint not masked”, and “Whole picture”&#x2F;“Only masked”, and “Only masked padding”&amp;”Mask blur”. The resizing perfectly matches A1111’s “Just resize”&#x2F;“Crop and resize”&#x2F;“Resize and fill”. This means you can use ControlNet in nearly everywhere in your A1111 UI without difficulty!</p>
<h3 id="The-New-“Pixel-Perfect”-Mode"><a href="#The-New-“Pixel-Perfect”-Mode" class="headerlink" title="The New “Pixel-Perfect” Mode"></a>The New “Pixel-Perfect” Mode</h3><p>Now if you turn on pixel-perfect mode, you do not need to set preprocessor (annotator) resolutions manually. The ControlNet will automatically compute the best annotator resolution for you so that each pixel perfectly matches Stable Diffusion.</p>
<h3 id="User-Friendly-GUI-and-Preprocessor-Preview"><a href="#User-Friendly-GUI-and-Preprocessor-Preview" class="headerlink" title="User-Friendly GUI and Preprocessor Preview"></a>User-Friendly GUI and Preprocessor Preview</h3><p>We reorganized some previously confusing UI like “canvas width&#x2F;height for new canvas” and it is in the 📝 button now. Now the preview GUI is controlled by the “allow preview” option and the trigger button 💥. The preview image size is better than before, and you do not need to scroll up and down - your a1111 GUI will not be messed up anymore!</p>
<h3 id="Support-for-Almost-All-Upscaling-Scripts"><a href="#Support-for-Almost-All-Upscaling-Scripts" class="headerlink" title="Support for Almost All Upscaling Scripts"></a>Support for Almost All Upscaling Scripts</h3><p>Now ControlNet 1.1 can support almost all Upscaling&#x2F;Tile methods. ControlNet 1.1 support the script “Ultimate SD upscale” and almost all other tile-based extensions. Please do not confuse <a target="_blank" rel="noopener" href="https://github.com/Coyote-A/ultimate-upscale-for-automatic1111">“Ultimate SD upscale”</a> with “SD upscale” - they are different scripts. Note that the most recommended upscaling method is <a target="_blank" rel="noopener" href="https://github.com/pkuliyi2015/multidiffusion-upscaler-for-automatic1111">“Tiled VAE&#x2F;Diffusion”</a> but we test as many methods&#x2F;extensions as possible. Note that “SD upscale” is supported since 1.1.117, and if you use it, you need to leave all ControlNet images as blank (We do not recommend “SD upscale” since it is somewhat buggy and cannot be maintained - use the “Ultimate SD upscale” instead).</p>
<h3 id="More-Control-Modes-previously-called-Guess-Mode"><a href="#More-Control-Modes-previously-called-Guess-Mode" class="headerlink" title="More Control Modes (previously called Guess Mode)"></a>More Control Modes (previously called Guess Mode)</h3><p>We have fixed many bugs in previous 1.0’s Guess Mode and now it is called Control Mode</p>
<p><img src="https://user-images.githubusercontent.com/19834515/236641759-6c44ddf6-c7ad-4bda-92be-e90a52911d75.png" alt="image"></p>
<p>Now you can control which aspect is more important (your prompt or your ControlNet)：</p>
<ul>
<li><p>“Balanced”: ControlNet on both sides of CFG scale, same as turning off “Guess Mode” in ControlNet 1.0</p>
</li>
<li><p>“My prompt is more important”: ControlNet on both sides of CFG scale, with progressively reduced SD U-Net injections (layer_weight*&#x3D;0.825**I, where 0&lt;&#x3D;I &lt;13, and the 13 means ControlNet injected SD 13 times). In this way, you can make sure that your prompts are perfectly displayed in your generated images.</p>
</li>
<li><p>“ControlNet is more important”: ControlNet only on the Conditional Side of CFG scale (the cond in A1111’s batch-cond-uncond). This means the ControlNet will be X times stronger if your cfg-scale is X. For example, if your cfg-scale is 7, then ControlNet is 7 times stronger. Note that here the X times stronger is different from “Control Weights” since your weights are not modified. This “stronger” effect usually has less artifact and give ControlNet more room to guess what is missing from your prompts (and in the previous 1.0, it is called “Guess Mode”).</p>
</li>
</ul>
<table width="100%">
<tr>
<td width="25%" style="text-align: center">Input (depth+canny+hed)</td>
<td width="25%" style="text-align: center">"Balanced"</td>
<td width="25%" style="text-align: center">"My prompt is more important"</td>
<td width="25%" style="text-align: center">"ControlNet is more important"</td>
</tr>
<tr>
<td width="25%" style="text-align: center"><img src="/.com//cm1.png"></td>
<td width="25%" style="text-align: center"><img src="/.com//cm2.png"></td>
<td width="25%" style="text-align: center"><img src="/.com//cm3.png"></td>
<td width="25%" style="text-align: center"><img src="/.com//cm4.png"></td>
</tr>
</table>

<h3 id="Reference-Only-Control"><a href="#Reference-Only-Control" class="headerlink" title="Reference-Only Control"></a>Reference-Only Control</h3><p>Now we have a <code>reference-only</code> preprocessor that does not require any control models. It can guide the diffusion directly using images as references.</p>
<p>(Prompt “a dog running on grassland, best quality, …”)</p>
<p><img src="/.com//ref.png" alt="image"></p>
<p>This method is similar to inpaint-based reference but it does not make your image disordered. </p>
<p>Many professional A1111 users know a trick to diffuse image with references by inpaint. For example, if you have a 512x512 image of a dog, and want to generate another 512x512 image with the same dog, some users will connect the 512x512 dog image and a 512x512 blank image into a 1024x512 image, send to inpaint, and mask out the blank 512x512 part to diffuse a dog with similar appearance. However, that method is usually not very satisfying since images are connected and many distortions will appear.</p>
<p>This <code>reference-only</code> ControlNet can directly link the attention layers of your SD to any independent images, so that your SD will read arbitary images for reference. You need at least ControlNet 1.1.153 to use it.</p>
<p>To use, just select <code>reference-only</code> as preprocessor and put an image. Your SD will just use the image as reference.</p>
<p><em>Note that this method is as “non-opinioned” as possible. It only contains very basic connection codes, without any personal preferences, to connect the attention layers with your reference images. However, even if we tried best to not include any opinioned codes, we still need to write some subjective implementations to deal with weighting, cfg-scale, etc - tech report is on the way.</em></p>
<p>More examples <a target="_blank" rel="noopener" href="https://github.com/Mikubill/sd-webui-controlnet/discussions/1236">here</a>.</p>
<h1 id="Technical-Documents"><a href="#Technical-Documents" class="headerlink" title="Technical Documents"></a>Technical Documents</h1><p>See also the documents of ControlNet 1.1: </p>
<p><a target="_blank" rel="noopener" href="https://github.com/lllyasviel/ControlNet-v1-1-nightly#model-specification">https://github.com/lllyasviel/ControlNet-v1-1-nightly#model-specification</a></p>
<h1 id="Default-Setting"><a href="#Default-Setting" class="headerlink" title="Default Setting"></a>Default Setting</h1><p>This is my setting. If you run into any problem, you can use this setting as a sanity check</p>
<p><img src="https://user-images.githubusercontent.com/19834515/235620638-17937171-8ac1-45bc-a3cb-3aebf605b4ef.png" alt="image"></p>
<h1 id="Use-Previous-Models"><a href="#Use-Previous-Models" class="headerlink" title="Use Previous Models"></a>Use Previous Models</h1><h3 id="Use-ControlNet-1-0-Models"><a href="#Use-ControlNet-1-0-Models" class="headerlink" title="Use ControlNet 1.0 Models"></a>Use ControlNet 1.0 Models</h3><p><a target="_blank" rel="noopener" href="https://huggingface.co/lllyasviel/ControlNet/tree/main/models">https://huggingface.co/lllyasviel/ControlNet/tree/main/models</a></p>
<p>You can still use all previous models in the previous ControlNet 1.0. Now, the previous “depth” is now called “depth_midas”, the previous “normal” is called “normal_midas”, the previous “hed” is called “softedge_hed”. And starting from 1.1, all line maps, edge maps, lineart maps, boundary maps will have black background and white lines.</p>
<h3 id="Use-T2I-Adapter-Models"><a href="#Use-T2I-Adapter-Models" class="headerlink" title="Use T2I-Adapter Models"></a>Use T2I-Adapter Models</h3><p>(From TencentARC&#x2F;T2I-Adapter)</p>
<p>To use T2I-Adapter models:</p>
<ol>
<li>Download files from <a target="_blank" rel="noopener" href="https://huggingface.co/TencentARC/T2I-Adapter/tree/main/models">https://huggingface.co/TencentARC/T2I-Adapter/tree/main/models</a></li>
<li>Put them in “stable-diffusion-webui\extensions\sd-webui-controlnet\models”.</li>
<li>Make sure that the file names of pth files and yaml files are consistent.</li>
</ol>
<p><em>Note that “CoAdapter” is not implemented yet.</em></p>
<h1 id="Gallery"><a href="#Gallery" class="headerlink" title="Gallery"></a>Gallery</h1><p>The below results are from ControlNet 1.0.</p>
<table>
<thead>
<tr>
<th align="center">Source</th>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center">(no preprocessor)</td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/bal-source.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/bal-gen.png?raw=true"></td>
</tr>
<tr>
<td align="center">(no preprocessor)</td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/dog_rel.jpg?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/dog_rel.png?raw=true"></td>
</tr>
<tr>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/mahiro_input.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/mahiro_canny.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/mahiro-out.png?raw=true"></td>
</tr>
<tr>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/evt_source.jpg?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/evt_hed.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/evt_gen.png?raw=true"></td>
</tr>
<tr>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/an-source.jpg?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/an-pose.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/an-gen.png?raw=true"></td>
</tr>
<tr>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/sk-b-src.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/sk-b-dep.png?raw=true"></td>
<td align="center"><img width="256" alt src="https://github.com/Mikubill/sd-webui-controlnet/blob/main/samples/sk-b-out.png?raw=true"></td>
</tr>
</tbody></table>
<p>The below examples are from T2I-Adapter.</p>
<p>From <code>t2iadapter_color_sd14v1.pth</code> :</p>
<table>
<thead>
<tr>
<th align="center">Source</th>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><img width="256" alt src="https://user-images.githubusercontent.com/31246794/222947416-ec9e52a4-a1d0-48d8-bb81-736bf636145e.jpeg"></td>
<td align="center"><img width="256" alt src="https://user-images.githubusercontent.com/31246794/222947435-1164e7d8-d857-42f9-ab10-2d4a4b25f33a.png"></td>
<td align="center"><img width="256" alt src="https://user-images.githubusercontent.com/31246794/222947557-5520d5f8-88b4-474d-a576-5c9cd3acac3a.png"></td>
</tr>
</tbody></table>
<p>From <code>t2iadapter_style_sd14v1.pth</code> :</p>
<table>
<thead>
<tr>
<th align="center">Source</th>
<th align="center">Input</th>
<th align="center">Output</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><img width="256" alt src="https://user-images.githubusercontent.com/31246794/222947416-ec9e52a4-a1d0-48d8-bb81-736bf636145e.jpeg"></td>
<td align="center">(clip, non-image)</td>
<td align="center"><img width="256" alt src="https://user-images.githubusercontent.com/31246794/222965711-7b884c9e-7095-45cb-a91c-e50d296ba3a2.png"></td>
</tr>
</tbody></table>
<h1 id="Minimum-Requirements"><a href="#Minimum-Requirements" class="headerlink" title="Minimum Requirements"></a>Minimum Requirements</h1><ul>
<li>(Windows) (NVIDIA: Ampere) 4gb - with <code>--xformers</code> enabled, and <code>Low VRAM</code> mode ticked in the UI, goes up to 768x832</li>
</ul>
<h1 id="Multi-ControlNet"><a href="#Multi-ControlNet" class="headerlink" title="Multi-ControlNet"></a>Multi-ControlNet</h1><p>This option allows multiple ControlNet inputs for a single generation. To enable this option, change <code>Multi ControlNet: Max models amount (requires restart)</code> in the settings. Note that you will need to restart the WebUI for changes to take effect.</p>
<table width="100%">
<tr>
<td width="25%" style="text-align: center">Source A</td>
<td width="25%" style="text-align: center">Source B</td>
<td width="25%" style="text-align: center">Output</td>
</tr>
<tr>
<td width="25%" style="text-align: center"><img src="https://user-images.githubusercontent.com/31246794/220448620-cd3ede92-8d3f-43d5-b771-32dd8417618f.png"></td>
<td width="25%" style="text-align: center"><img src="https://user-images.githubusercontent.com/31246794/220448619-beed9bdb-f6bb-41c2-a7df-aa3ef1f653c5.png"></td>
<td width="25%" style="text-align: center"><img src="https://user-images.githubusercontent.com/31246794/220448613-c99a9e04-0450-40fd-bc73-a9122cefaa2c.png"></td>
</tr>
</table>

<h1 id="Control-Weight-x2F-Start-x2F-End"><a href="#Control-Weight-x2F-Start-x2F-End" class="headerlink" title="Control Weight&#x2F;Start&#x2F;End"></a>Control Weight&#x2F;Start&#x2F;End</h1><p>Weight is the weight of the controlnet “influence”. It’s analogous to prompt attention&#x2F;emphasis. E.g. (myprompt: 1.2). Technically, it’s the factor by which to multiply the ControlNet outputs before merging them with original SD Unet.</p>
<p>Guidance Start&#x2F;End is the percentage of total steps the controlnet applies (guidance strength &#x3D; guidance end). It’s analogous to prompt editing&#x2F;shifting. E.g. [myprompt::0.8] (It applies from the beginning until 80% of total steps)</p>
<h1 id="Batch-Mode"><a href="#Batch-Mode" class="headerlink" title="Batch Mode"></a>Batch Mode</h1><p>Put any unit into batch mode to activate batch mode for all units. Specify a batch directory for each unit, or use the new textbox in the img2img batch tab as a fallback. Although the textbox is located in the img2img batch tab, you can use it to generate images in the txt2img tab as well.</p>
<p>Note that this feature is only available in the gradio user interface. Call the APIs as many times as you want for custom batch scheduling.</p>
<h1 id="API-and-Script-Access"><a href="#API-and-Script-Access" class="headerlink" title="API and Script Access"></a>API and Script Access</h1><p>This extension can accept txt2img or img2img tasks via API or external extension call. Note that you may need to enable <code>Allow other scripts to control this extension</code> in settings for external calls.</p>
<p>To use the API: start WebUI with argument <code>--api</code> and go to <code>http://webui-address/docs</code> for documents or checkout <a target="_blank" rel="noopener" href="https://github.com/Mikubill/sd-webui-controlnet/blob/main/example/api_txt2img.ipynb">examples</a>.</p>
<p>To use external call: Checkout <a target="_blank" rel="noopener" href="https://github.com/Mikubill/sd-webui-controlnet/wiki/API">Wiki</a></p>
<h1 id="Command-Line-Arguments"><a href="#Command-Line-Arguments" class="headerlink" title="Command Line Arguments"></a>Command Line Arguments</h1><p>This extension adds these command line arguments to the webui:</p>
<pre><code>    --controlnet-dir &lt;path to directory with controlnet models&gt;                                ADD a controlnet models directory
    --controlnet-annotator-models-path &lt;path to directory with annotator model directories&gt;    SET the directory for annotator models
    --no-half-controlnet                                                                       load controlnet models in full precision
    --controlnet-preprocessor-cache-size                                                       Cache size for controlnet preprocessor results
    --controlnet-loglevel                                                                      Log level for the controlnet extension
</code></pre>
<h1 id="MacOS-Support"><a href="#MacOS-Support" class="headerlink" title="MacOS Support"></a>MacOS Support</h1><p>Tested with pytorch nightly: <a target="_blank" rel="noopener" href="https://github.com/Mikubill/sd-webui-controlnet/pull/143#issuecomment-1435058285">https://github.com/Mikubill/sd-webui-controlnet/pull/143#issuecomment-1435058285</a></p>
<p>To use this extension with mps and normal pytorch, currently you may need to start WebUI with <code>--no-half</code>.</p>
<h1 id="Archive-of-Deprecated-Versions"><a href="#Archive-of-Deprecated-Versions" class="headerlink" title="Archive of Deprecated Versions"></a>Archive of Deprecated Versions</h1><p>The previous version (sd-webui-controlnet 1.0) is archived in </p>
<p><a target="_blank" rel="noopener" href="https://github.com/lllyasviel/webui-controlnet-v1-archived">https://github.com/lllyasviel/webui-controlnet-v1-archived</a></p>
<p>Using this version is not a temporary stop of updates. You will stop all updates forever.</p>
<p>Please consider this version if you work with professional studios that requires 100% reproducing of all previous results pixel by pixel.</p>
<h1 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h1><p>This implementation is inspired by kohya-ss&#x2F;sd-webui-additional-networks</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/22/ControlNet%20for%20Stable%20Diffusion%20WebUI/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/22/%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E6%88%91%E4%BB%AC%E6%8F%90%E5%87%BA%E4%BA%86%E5%8F%A6%E4%B8%80%E7%A7%8D%E7%AE%80%E5%8D%95%E8%80%8C%E6%9C%89%E6%95%88%E7%9A%84%E6%9D%A1%E4%BB%B6%E5%8C%96%E6%96%B9%E6%B3%95%EF%BC%9A%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E6%9C%9F%E9%97%B4%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9D%87%E5%8C%80%E5%9C%B0%E9%87%87%E6%A0%B7%E8%A3%81%E5%89%AA%E5%9D%90%E6%A0%87ctop%20c_%7Btext%20%7Btop%20%7D%7D%20%E5%92%8C%20cleft%20c_%7Btext%20%7Bleft%20%7D%7D%EF%BC%88%E5%88%86%E5%88%AB%E6%8C%87%E5%AE%9A%E4%BB%8E%E5%B7%A6%E4%B8%8A%E8%A7%92%E6%B2%BF%E9%AB%98%E5%BA%A6%E5%92%8C%E5%AE%BD%E5%BA%A6%E8%BD%B4%E8%A3%81%E5%89%AA%E7%9A%84%E5%83%8F%E7%B4%A0%E6%95%B0%E9%87%8F%E7%9A%84%E6%95%B4/">
        <h2 class="post-title"></h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/22
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>为了解决这个问题，我们提出了另一种简单而有效的条件化方法：在数据加载期间，我们均匀地采样裁剪坐标$c_{\text {top }}$ 和 $c_{\text {left }}$（分别指定从左上角沿高度和宽度轴裁剪的像素数量的整数），并通过傅立叶特征嵌入将它们作为条件参数输入到模型中，类似于上述的大小条件化。然后，连接的嵌入$\mathbf{c}<em>{\mathrm{crop}}$被用作额外的条件参数。我们强调，这种技术不仅限于LDMs，可以用于任何DM。注意，裁剪和大小条件化可以轻松地结合起来。在这种情况下，我们在将其添加到UNet的时间步嵌入之前，沿着通道维度连接特征嵌入。算法1说明了在应用这种组合时，我们如何在训练期间采样$\mathbf{c}</em>{\text {crop }}$ 和 $\mathbf{c}_{\text {size }}$。</p>
<p>考虑到我们的经验是，大规模数据集平均来说是以对象为中心的，我们在推理期间设置$\left(c_{\text {top }}, c_{\text {left }}\right)&#x3D;$ $(0,0)$，从而从训练模型中获得以对象为中心的样本。</p>
<p>请参见图5的说明：通过调整$\left(c_{\text {top }}, c_{\text {left }}\right)$，我们可以成功地模拟推理期间的裁剪量。这是一种条件化增强的形式，已经在自回归模型[20]和最近的扩散模型[21]中以各种形式使用。</p>
<p>虽然其他方法，如数据分桶[31]，成功地解决了同样的任务，但我们仍然从裁剪引起的数据增强中受益，同时确保它不会渗入生成过程 - 我们实际上利用它来获得对图像合成过程的更多控制。此外，它易于实现，并且可以在训练期间在线应用，无需额外的数据预处理。</p>
<p>这个伪代码描述了一个用于图像处理的算法，它包括调整图像大小和裁剪图像的步骤。这个算法的目标是将输入的图像调整到指定的大小，并在需要的情况下进行裁剪。以下是对每一段的解释：</p>
<ol>
<li><p><strong>Require: Training dataset of images</strong> $\mathcal{D}$ <strong>, target image size for training</strong> $\boldsymbol{s}&#x3D;\left(h_{\text {tgt }}, w_{\text {tgt }}\right)$</p>
<p>这一段定义了算法的输入。需要一个图像的训练数据集$\mathcal{D}$，以及目标图像的大小$\boldsymbol{s}$，其中$h_{\text {tgt }}$和$w_{\text {tgt }}$分别代表目标图像的高度和宽度。</p>
</li>
<li><p><strong>Require: Resizing function</strong> $\boldsymbol{R}$ <strong>, cropping function function</strong> $\boldsymbol{C}$</p>
<p>这一段定义了两个函数，一个是用于调整图像大小的函数$\boldsymbol{R}$，另一个是用于裁剪图像的函数$\boldsymbol{C}$。</p>
</li>
<li><p><strong>Require: Model train step</strong> $\boldsymbol{T}$</p>
<p>这一段定义了模型训练的步骤函数$\boldsymbol{T}$。</p>
</li>
<li><p><strong>converged</strong> $\leftarrow$ <strong>False</strong></p>
<p>这一段初始化了一个名为”converged”的变量，其初始值为False。这个变量用于控制训练过程的结束，当模型收敛（即模型的训练误差不再显著下降或者达到预设的训练轮数）时，这个变量将被设置为True。</p>
</li>
<li><p><strong>while not converged do</strong></p>
<p>这一段开始了一个循环，只有当”converged”变量为False时，循环才会继续。也就是说，只要模型还没有收敛，就会继续执行循环中的步骤。</p>
</li>
<li><p><strong>x $\sim$ $\mathcal{D}$</strong></p>
<p>这一段从训练数据集$\mathcal{D}$中随机选择一个图像作为输入。</p>
</li>
<li><p><strong>$w_{\text {original }} \leftarrow \text { width }(x)$</strong></p>
<p><strong>$h_{\text {original }} \leftarrow \text { height }(x)$</strong></p>
<p>这两段获取了选定图像的原始宽度和高度。</p>
</li>
<li><p><strong>$\mathbf{c}<em>{\text {size }} \leftarrow\left(h</em>{\text {original }}, w_{\text {original }}\right)$</strong></p>
<p>这一段创建了一个向量$\mathbf{c}_{\text {size }}$，其中包含了图像的原始高度和宽度。</p>
</li>
<li><p><strong>x $\leftarrow$ $\boldsymbol{R}(x, \boldsymbol{s})$</strong></p>
<p>这一段使用调整大小的函数$\boldsymbol{R}$将图像调整到目标大小$\boldsymbol{s}$。</p>
</li>
<li><p><strong>if $h_{\text {original }} \leq w_{\text {original }}$ then</strong></p>
<p><strong>$c_{\text {left }} \sim \mathcal{U}\left(0, \text { width }(x)-s_w\right)$</strong></p>
<p><strong>$c_{\text {top }}&#x3D;0$</strong></p>
<p><strong>else if $h_{\text {original }}&gt;w_{\text {original }}$ then</strong></p>
<p><strong>$c_{\text {top }} \sim \mathcal{U}\left(0, \text { height }(x)-s_h\right)$</strong></p>
<p><strong>$c_{\text {left }}&#x3D;0$</strong></p>
<p><strong>end if</strong></p>
<p>这一段决定了裁剪的位置。如果原始图像的高度小于或等于宽度，那么将从左侧随机裁剪；如果原始图像的高度大于宽度，那么将从顶部随机裁剪。</p>
</li>
<li><p><strong>$\mathbf{c}<em>{\text {crop }} \leftarrow\left(c</em>{\text {top }}, c_{\text {left }}\right)$</strong></p>
<p>这一段创建了一个向量$\mathbf{c}_{\text {crop }}$，其中包含了裁剪的位置。</p>
</li>
<li><p><strong>x $\leftarrow$ $\boldsymbol{C}\left(x, \boldsymbol{s}, \mathbf{c}_{\text {crop }}\right)$</strong></p>
<p>这一段使用裁剪函数$\boldsymbol{C}$将图像裁剪到目标大小$\boldsymbol{s}$，并在指定的位置$\mathbf{c}_{\text {crop }}$进行裁剪。</p>
</li>
<li><p><strong>converged $\leftarrow$ $\boldsymbol{T}\left(x, \mathbf{c}<em>{\text {size }}, \mathbf{c}</em>{\mathrm{crop}}\right)$</strong></p>
<p>这一段执行模型训练的步骤，并将结果赋值给”converged”变量。如果模型已经收敛，那么”converged”变量将被设置为True，从而结束循环。</p>
</li>
<li><p><strong>end while</strong></p>
<p>这一段标志着循环的结束。当”converged”变量为True时，循环将结束，模型训练也就完成了。</p>
</li>
</ol>
<p>在这个伪代码中，$\mathbf{c}<em>{\mathrm{crop}}$ 是一个向量，它包含了裁剪图像的位置信息。具体来说，它由两个元素组成：$c</em>{\text {top }}$ 和 $c_{\text {left }}$。</p>
<p>$c_{\text {top }}$ 是从图像顶部开始裁剪的位置，$c_{\text {left }}$ 是从图像左侧开始裁剪的位置。这两个值决定了裁剪框的起始点。</p>
<p>在这个算法中，如果原始图像的高度小于或等于宽度，那么将从左侧随机裁剪，此时 $c_{\text {left }}$ 会从均匀分布 $\mathcal{U}\left(0, \text { width }(x)-s_w\right)$ 中随机取值，而 $c_{\text {top }}$ 则被设为 0。反之，如果原始图像的高度大于宽度，那么将从顶部随机裁剪，此时 $c_{\text {top }}$ 会从均匀分布 $\mathcal{U}\left(0, \text { height }(x)-s_h\right)$ 中随机取值，而 $c_{\text {left }}$ 则被设为 0。</p>
<p>这样，$\mathbf{c}_{\mathrm{crop}}$ 就定义了裁剪框的起始点，然后根据目标图像的大小 $\boldsymbol{s}$，就可以确定裁剪框的大小，从而完成图像的裁剪。</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/22/%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E6%88%91%E4%BB%AC%E6%8F%90%E5%87%BA%E4%BA%86%E5%8F%A6%E4%B8%80%E7%A7%8D%E7%AE%80%E5%8D%95%E8%80%8C%E6%9C%89%E6%95%88%E7%9A%84%E6%9D%A1%E4%BB%B6%E5%8C%96%E6%96%B9%E6%B3%95%EF%BC%9A%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E6%9C%9F%E9%97%B4%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9D%87%E5%8C%80%E5%9C%B0%E9%87%87%E6%A0%B7%E8%A3%81%E5%89%AA%E5%9D%90%E6%A0%87ctop%20c_%7Btext%20%7Btop%20%7D%7D%20%E5%92%8C%20cleft%20c_%7Btext%20%7Bleft%20%7D%7D%EF%BC%88%E5%88%86%E5%88%AB%E6%8C%87%E5%AE%9A%E4%BB%8E%E5%B7%A6%E4%B8%8A%E8%A7%92%E6%B2%BF%E9%AB%98%E5%BA%A6%E5%92%8C%E5%AE%BD%E5%BA%A6%E8%BD%B4%E8%A3%81%E5%89%AA%E7%9A%84%E5%83%8F%E7%B4%A0%E6%95%B0%E9%87%8F%E7%9A%84%E6%95%B4/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/21/ControlNet%E9%80%9A%E8%BF%87%E6%93%8D%E7%BA%B5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%9D%97%E7%9A%84%E8%BE%93%E5%85%A5%E6%9D%A1%E4%BB%B6%EF%BC%8C%E4%BB%A5%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%8E%A7%E5%88%B6%E6%95%B4%E4%B8%AA%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E6%95%B4%E4%BD%93%E8%A1%8C%E4%B8%BA%E3%80%82%E5%9C%A8%E8%BF%99%E9%87%8C%EF%BC%8C%E7%BD%91%E7%BB%9C%E5%9D%97%E6%8C%87%E7%9A%84%E6%98%AF%E4%B8%80%E7%BB%84%E8%A2%AB%E7%BB%84%E5%90%88%E5%9C%A8%E4%B8%80%E8%B5%B7%E4%BD%9C%E4%B8%BA%E5%B8%B8%E7%94%A8%E5%8D%95%E5%85%83%E6%9D%A5%E6%9E%84%E5%BB%BA%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E7%A5%9E%E7%BB%8F%E5%B1%82%EF%BC%8C%E4%BE%8B%E5%A6%82%20resnet%20%E5%9D%97%EF%BC%8Cconv-bn-relu%20%E5%9D%97%EF%BC%8C%E5%A4%9A%E5%A4%B4%E6%B3%A8%E6%84%8F%E5%8A%9B%E5%9D%97%EF%BC%8C%E5%8F%98/">
        <h2 class="post-title"></h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/21
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>ControlNet通过操纵神经网络块的输入条件，以进一步控制整个神经网络的整体行为。在这里，”网络块”指的是一组被组合在一起作为常用单元来构建神经网络的神经层，例如 “resnet” 块，”conv-bn-relu” 块，多头注意力块，变压器块等。</p>
<p>以2D特征为例，给定一个特征图 $\boldsymbol{x} \in \mathbb{R}^{h \times w \times c}$，其中 ${h, w, c}$ 是高度，宽度和通道数，一个带有一组参数 $\Theta$ 的神经网络块 $\mathcal{F}(\cdot ; \Theta)$ 将 $\boldsymbol{x}$ 转换为另一个特征图 $\boldsymbol{y}$，有<br>$$<br>\boldsymbol{y}&#x3D;\mathcal{F}(\boldsymbol{x} ; \Theta)<br>$$<br>这个过程在图 2-(a) 中进行了可视化。<br>我们锁定所有的参数在 $\Theta$ 中，然后将其克隆为一个可训练的副本 $\Theta_{\mathrm{c}}$。复制的 $\Theta_{\mathrm{c}}$ 与一个外部条件向量 $c$ 一起进行训练。在这篇论文中，我们将原始参数和新参数称为 “锁定副本” 和 “可训练副本”。制作这样的副本而不是直接训练原始权重的动机是为了避免在数据集小的时候过拟合，并保留从数十亿图像中学习的大型模型的生产就绪质量。</p>
<p>神经网络块通过一个称为 “零卷积” 的特殊类型的卷积层连接，即权重和偏置都初始化为零的 $1 \times 1$ 卷积层。我们将零卷积操作表示为 $\mathcal{Z}(\cdot ; \cdot)$，并使用两个参数实例 $\left{\Theta_{z 1}, \Theta_{z 2}\right}$ 来构成 ControlNet 结构，有<br>$$<br>\boldsymbol{y}<em>{\mathrm{c}}&#x3D;\mathcal{F}(\boldsymbol{x} ; \Theta)+\mathcal{Z}\left(\mathcal{F}\left(\boldsymbol{x}+\mathcal{Z}\left(\boldsymbol{c} ; \Theta</em>{\mathrm{z} 1}\right) ; \Theta_{\mathrm{c}}\right) ; \Theta_{\mathrm{z} 2}\right)<br>$$<br>其中 $\boldsymbol{y}<em>{\mathrm{c}}$ 成为这个神经网络块的输出，如图 2-(b) 所示。<br>因为零卷积层的权重和偏置都初始化为零，在第一步训练中，我们有<br>$$<br>\left{\begin{array}{l}<br>\mathcal{Z}\left(\boldsymbol{c} ; \Theta</em>{\mathrm{z} 1}\right)&#x3D;\mathbf{0} \<br>\mathcal{F}\left(\boldsymbol{x}+\mathcal{Z}\left(\boldsymbol{c} ; \Theta_{\mathrm{z} 1}\right) ; \Theta_{\mathrm{c}}\right)&#x3D;\mathcal{F}\left(\boldsymbol{x} ; \Theta_{\mathrm{c}}\right)&#x3D;\mathcal{F}(\boldsymbol{x} ; \Theta) \<br>\mathcal{Z}\left(\mathcal{F}\left(\boldsymbol{x}+\mathcal{Z}\left(\boldsymbol{c} ; \Theta_{\mathrm{z} 1}\right) ; \Theta_{\mathrm{c}}\right) ; \Theta_{\mathrm{z} 2}\right)&#x3D;\mathcal{Z}\left(\mathcal{F}\left(\boldsymbol{x} ; \Theta_{\mathrm{c}}\right) ; \Theta_{\mathrm{z} 2}\right)&#x3D;\mathbf{0}<br>\end{array}\right.<br>$$</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/21/ControlNet%E9%80%9A%E8%BF%87%E6%93%8D%E7%BA%B5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%9D%97%E7%9A%84%E8%BE%93%E5%85%A5%E6%9D%A1%E4%BB%B6%EF%BC%8C%E4%BB%A5%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%8E%A7%E5%88%B6%E6%95%B4%E4%B8%AA%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E6%95%B4%E4%BD%93%E8%A1%8C%E4%B8%BA%E3%80%82%E5%9C%A8%E8%BF%99%E9%87%8C%EF%BC%8C%E7%BD%91%E7%BB%9C%E5%9D%97%E6%8C%87%E7%9A%84%E6%98%AF%E4%B8%80%E7%BB%84%E8%A2%AB%E7%BB%84%E5%90%88%E5%9C%A8%E4%B8%80%E8%B5%B7%E4%BD%9C%E4%B8%BA%E5%B8%B8%E7%94%A8%E5%8D%95%E5%85%83%E6%9D%A5%E6%9E%84%E5%BB%BA%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E7%A5%9E%E7%BB%8F%E5%B1%82%EF%BC%8C%E4%BE%8B%E5%A6%82%20resnet%20%E5%9D%97%EF%BC%8Cconv-bn-relu%20%E5%9D%97%EF%BC%8C%E5%A4%9A%E5%A4%B4%E6%B3%A8%E6%84%8F%E5%8A%9B%E5%9D%97%EF%BC%8C%E5%8F%98/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/21/%E4%BD%A0%E7%BB%99%E5%87%BA%E7%9A%84%E8%BF%99%E4%B8%A4%E4%B8%AA%E6%96%B9%E7%A8%8B%E6%98%AF%E6%8F%8F%E8%BF%B0%E4%B8%A4%E4%B8%AA%E8%80%A6%E5%90%88%E8%B0%90%E6%8C%AF%E5%99%A8%E7%9A%84%E5%8A%A8%E5%8A%9B%E5%AD%A6%E7%9A%84%E8%80%A6%E5%90%88%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E3%80%82%E4%BD%A0%E7%BB%99%E5%87%BA%E7%9A%84%E5%93%88%E5%AF%86%E9%A1%BF%E9%87%8F%E6%98%AF%E7%B3%BB%E7%BB%9F%E8%83%BD%E9%87%8F%E7%9A%84%E7%9F%A9%E9%98%B5%E8%A1%A8%E7%A4%BA%EF%BC%8C%E5%AF%B9%E8%A7%92%E5%85%83%E7%B4%A0%E4%BB%A3%E8%A1%A8%E6%AF%8F%E4%B8%AA%E8%B0%90%E6%8C%AF%E5%99%A8%E7%9A%84%E8%83%BD%E9%87%8F%EF%BC%8C%E9%9D%9E%E5%AF%B9%E8%A7%92%E5%85%83%E7%B4%A0%E4%BB%A3%E8%A1%A8%E4%B8%A4%E4%B8%AA%E8%B0%90%E6%8C%AF%E5%99%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E8%80%A6%E5%90%88%E3%80%82/">
        <h2 class="post-title"></h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/21
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>你给出的这两个方程是描述两个耦合谐振器的动力学的耦合微分方程。你给出的哈密顿量是系统能量的矩阵表示，对角元素代表每个谐振器的能量，非对角元素代表两个谐振器之间的耦合。</p>
<p>在这里，ω_c 和 ω_m 代表两个谐振器的频率。你给出的哈密顿量矩阵的对角元素包含了这些频率。</p>
<p>如果你问为什么哈密顿量矩阵中没有明确出现 ω，那是因为它们已经被吸收到矩阵的对角元素的复数中。换句话说，这些复数的实部代表频率 ω_c 和 ω_m，虚部代表两个谐振器的阻尼率（β 和 α）。</p>
<p>如果你问为什么微分方程中没有 ω，那是因为这些方程是在旋转参考系中写出的，其中振动的频率已经被“旋转”掉了。这是物理中常用的一种简化振动系统分析的技术。频率 ω 仍然影响系统的动力学，但它是通过方程中的参数（如耦合强度 J 和阻尼率 β 和 α）间接地影响。</p>
<p>以下是这个过程的推导：</p>
<p>首先，我们可以将这两个耦合微分方程写为矩阵形式：</p>
<p>$$<br>\begin{aligned}<br>&amp; \left[i\left(\omega-\omega_c\right)-\beta\right] \hat{a}-(i J-\sqrt{\kappa \gamma}) \hat{m}&#x3D;0, \<br>&amp; \left[i\left(\omega-\omega_m\right)-\alpha\right] \hat{m}-(i J-\sqrt{\kappa \gamma}) \hat{a}&#x3D;0,<br>\end{aligned}<br>$$</p>
<p>可以写为：</p>
<h1 id="begin-bmatrix-i-omega-omega-c-beta-amp-iJ-sqrt-kappa-gamma-iJ-sqrt-kappa-gamma-amp-i-omega-omega-m-alpha-end-bmatrix-begin-bmatrix-hat-a-hat-m-end-bmatrix"><a href="#begin-bmatrix-i-omega-omega-c-beta-amp-iJ-sqrt-kappa-gamma-iJ-sqrt-kappa-gamma-amp-i-omega-omega-m-alpha-end-bmatrix-begin-bmatrix-hat-a-hat-m-end-bmatrix" class="headerlink" title="$$\begin{bmatrix}i(\omega-\omega_c)-\beta &amp; -(iJ-\sqrt{\kappa \gamma}) \-(iJ-\sqrt{\kappa \gamma}) &amp; i(\omega-\omega_m)-\alpha\end{bmatrix}\begin{bmatrix}\hat{a} \\hat{m}\end{bmatrix}"></a>$$<br>\begin{bmatrix}<br>i(\omega-\omega_c)-\beta &amp; -(iJ-\sqrt{\kappa \gamma}) \<br>-(iJ-\sqrt{\kappa \gamma}) &amp; i(\omega-\omega_m)-\alpha<br>\end{bmatrix}<br>\begin{bmatrix}<br>\hat{a} \<br>\hat{m}<br>\end{bmatrix}</h1><p>\begin{bmatrix}<br>0 \<br>0<br>\end{bmatrix}<br>$$</p>
<p>这个矩阵方程的解就是哈密顿量矩阵的本征值问题，所以我们可以将这个矩阵方程写为哈密顿量矩阵的形式：</p>
<p>$$<br>H_{e f f} &#x2F; \hbar&#x3D;\left[\begin{array}{cc}<br>\omega_c-i \beta &amp; J+i \Gamma \<br>J+i \Gamma &amp; \omega_m-i \alpha<br>\end{array}\right]<br>$$</p>
<p>其中，$\omega_c$ 和 $\omega_m$ 是两个谐振器的频率，$\beta$ 和 $\alpha$ 是两个谐振器的阻尼率，$J$ 是两个谐振器之间的耦合强度，$\Gamma$ 是耦合的阻尼率。</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/21/%E4%BD%A0%E7%BB%99%E5%87%BA%E7%9A%84%E8%BF%99%E4%B8%A4%E4%B8%AA%E6%96%B9%E7%A8%8B%E6%98%AF%E6%8F%8F%E8%BF%B0%E4%B8%A4%E4%B8%AA%E8%80%A6%E5%90%88%E8%B0%90%E6%8C%AF%E5%99%A8%E7%9A%84%E5%8A%A8%E5%8A%9B%E5%AD%A6%E7%9A%84%E8%80%A6%E5%90%88%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E3%80%82%E4%BD%A0%E7%BB%99%E5%87%BA%E7%9A%84%E5%93%88%E5%AF%86%E9%A1%BF%E9%87%8F%E6%98%AF%E7%B3%BB%E7%BB%9F%E8%83%BD%E9%87%8F%E7%9A%84%E7%9F%A9%E9%98%B5%E8%A1%A8%E7%A4%BA%EF%BC%8C%E5%AF%B9%E8%A7%92%E5%85%83%E7%B4%A0%E4%BB%A3%E8%A1%A8%E6%AF%8F%E4%B8%AA%E8%B0%90%E6%8C%AF%E5%99%A8%E7%9A%84%E8%83%BD%E9%87%8F%EF%BC%8C%E9%9D%9E%E5%AF%B9%E8%A7%92%E5%85%83%E7%B4%A0%E4%BB%A3%E8%A1%A8%E4%B8%A4%E4%B8%AA%E8%B0%90%E6%8C%AF%E5%99%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E8%80%A6%E5%90%88%E3%80%82/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/07/02/DeepMD%E8%AF%A6%E7%BB%86%E5%86%85%E5%AE%B9%E4%BB%8B%E7%BB%8D/">
        <h2 class="post-title">DeepMD详细内容介绍</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/7/2
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <h1 id="DeePMD-调研报告"><a href="#DeePMD-调研报告" class="headerlink" title="DeePMD 调研报告"></a>DeePMD 调研报告</h1><ul>
<li><a href="#%E7%AE%80%E4%BB%8B">简介</a></li>
<li><a href="#%E8%83%8C%E6%99%AF%E5%92%8C%E5%8A%A8%E6%9C%BA">背景和动机</a></li>
<li><a href="#deepmd-kit-%E6%A6%82%E8%BF%B0">DeePMD-kit 概述</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95">核心算法</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84">代码实现和网络架构</a></li>
<li><a href="#%E5%9B%BE%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%9C%A8-deepmd-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">图神经网络在 DeePMD 中的应用</a></li>
<li><a href="#%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B">应用案例</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0">性能评估</a></li>
<li><a href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%9A%84%E6%AF%94%E8%BE%83">与其他工具的比较</a></li>
<li><a href="#%E7%A4%BE%E5%8C%BA%E5%92%8C%E8%B5%84%E6%BA%90">社区和资源</a></li>
<li><a href="#%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B">未来展望</a></li>
<li><a href="#%E7%BB%93%E8%AE%BA">结论</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>分子动力学（MD）模拟在凝聚态物理、材料科学、聚合物化学和分子生物学等领域具有广泛的应用，它允许研究人员检查原子或分子的行为，这在实验难以进行时尤为宝贵。然而，MD模拟的质量受到势能（PES）准确性的限制。传统上，有两种常见的模型：经验性原子势模型和量子力学模型。经验性原子势模型在计算上高效但准确性有限，而量子力学模型虽然准确度高，但计算成本很高。近年来，机器学习（ML）模型开始崭露头角，用于解决准确性和效率之间的权衡问题。ML模型通过训练来建立原子配置和势能之间的关系，并能达到与量子力学方法相当的准确性，同时具有更低的计算成本。深度势（DP）模型是ML模型的一种，它不仅具有量子力学精度，而且具有高计算效率，并且是端到端的，支持在现代高性能计算机上高效运行。</p>
<p><img src="/../images/image-20230701141805592.png" alt="image-20230701141805592"></p>
<h2 id="DeePMD-kit-概述"><a href="#DeePMD-kit-概述" class="headerlink" title="DeePMD-kit 概述"></a>DeePMD-kit 概述</h2><p>DeePMD-kit 是一个使用深度学习模型来高效模拟分子动力学的工具包。下面是相关的参考内容：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://docs.deepmodeling.com/projects/deepmd/en/master/index.html">文档</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://tutorials.deepmodeling.com/en/latest/">Tutorial</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/deepmodeling">GitHub主页</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.aissquare.com/">数据集和模型的共享平台</a></strong></li>
</ul>
<p><img src="/../images/image-20230701154308257.png" alt="figure"></p>
<!-- <img src="../images/image-20230701154308257.png" alt="image-20230701154308257" style="zoom:67%;" /> -->

<h3 id="DeePMD-kit-的工作流程"><a href="#DeePMD-kit-的工作流程" class="headerlink" title="DeePMD-kit 的工作流程"></a>DeePMD-kit 的工作流程</h3><ol>
<li><p><strong>准备训练数据</strong>：从量子力学模拟收集原子配置和相应的能量和力。</p>
</li>
<li><p><strong>配置 DeePMD-kit</strong>：创建输入文件，指定训练数据、神经网络结构和训练参数。</p>
</li>
<li><p><strong>描述符生成</strong>：DeePMD-kit 使用局部环境矩阵 $ \mathcal{R} $，它描述了特定原子及其邻居之间的距离和方向向量。</p>
</li>
<li><p><strong>嵌入网络</strong>：将每个距离嵌入到 $ M_1 $ 维向量中，从而将环境矩阵 $ \mathcal{R} $ 嵌入到矩阵 $ \mathcal{G} $ 中。</p>
</li>
<li><p><strong>拟合网络</strong>：通过矩阵乘法从 $ \mathcal{G} $ 中提取描述符向量，然后将描述符输入到拟合网络以获得预测能量。</p>
</li>
<li><p><strong>原子类型嵌入</strong>：DeePMD-kit v2.0 允许在不同原子类型之间共享嵌入网络和拟合网络，从而降低训练复杂性。</p>
</li>
</ol>
<p><img src="/../images/image-20230701140012565.png" alt="figure"><br><img src="/../images/image-20230701140054102.png" alt="figure"></p>
<!-- 

<img src="../images/image-20230701140012565.png" alt="image-20230701140012565" style="zoom:50%;" />
<img src="../images/image-20230701140054102.png" alt="image-20230701140054102" style="zoom:50%;" /> -->

<h3 id="DeePMD-kit-的原理"><a href="#DeePMD-kit-的原理" class="headerlink" title="DeePMD-kit 的原理"></a>DeePMD-kit 的原理</h3><h4 id="理论基础"><a href="#理论基础" class="headerlink" title="理论基础"></a>理论基础</h4><p>在介绍DP方法之前，我们定义了一个包含N个原子的系统的坐标矩阵$\mathcal{R} \in \mathbb{R}^{N \times 3}$，</p>
<p>$\mathcal{R}&#x3D;\left{\boldsymbol{r}_1^T, \cdots, \boldsymbol{r}_i^T, \cdots, \boldsymbol{r}_N^T\right}^T, \boldsymbol{r}_i&#x3D;\left(x_i, y_i, z_i\right),(1)$</p>
<p>$\boldsymbol{r}<em>i$包含原子$i$的3个笛卡尔坐标，$\boldsymbol{\mathcal { R }}$可以转换为局部环境矩阵$\left{\boldsymbol{\mathcal { R }}^i\right}</em>{i&#x3D;1}^N$</p>
<p>$\mathcal{R}^i&#x3D;\left{\boldsymbol{r}<em>{1 i}^T, \cdots, \boldsymbol{r}</em>{j i}^T, \cdots, \boldsymbol{r}<em>{N_i, i}^T\right}^T, \boldsymbol{r}</em>{j i}&#x3D;\left(x_{j i}, y_{j i}, z_{j i}\right),(2)$</p>
<p>其中$j$和$N_i$是原子$i$在截止半径$r_c$内的邻居的索引，$\boldsymbol{r}_{j i} \equiv \boldsymbol{r}_j-\boldsymbol{r}_i$被定义为相对坐标。<br>在DP方法中，系统的总能量$E$被构造为原子能量的总和。</p>
<p>$E&#x3D;\sum_i E_i,(3)$</p>
<p>其中$E_i$是原子$i$的局部原子能量。$E_i$取决于原子$i$的局部环境：</p>
<p>$E&#x3D;\sum_i E_i&#x3D;\sum_i E\left(\mathcal{R}^i\right),(4)$</p>
<p>$\mathcal{R}^i$到$E_i$的映射分两步构造。如下图所示，</p>
<p><img src="https://dp-public.oss-cn-beijing.aliyuncs.com/20220523-143747.png" alt="figure"></p>
<p>首先，$\mathcal{R}^i$被映射到一个特征矩阵，也称为描述符，$\mathcal{D}^i$，以保持系统的平移、旋转和排列对称性。$\mathcal{R}^i \in \mathbb{R}^{N_i \times 3}$首先被转换为广义坐标$\tilde{\mathcal{R}}^i \in \mathbb{R}^{N_i \times 4}$。</p>
<p>$\left{x_{j i}, y_{j i}, z_{j i}\right} \mapsto\left{s\left(r_{j i}\right), \hat{x}<em>{j i}, \hat{y}</em>{j i}, \hat{z}_{j i}\right}$</p>
<p>其中$\hat{x}<em>{j i}&#x3D;\frac{s\left(r</em>{j j}\right) x x_{j i}}{r_{j i}}, \hat{y}<em>{j i}&#x3D;\frac{s\left(r</em>{j j}\right) y \ddot{j}}{r_{j i}}$, 和 $\hat{z}<em>{j i}&#x3D;\frac{s\left(r</em>{j j}\right) z j i}{r_{j i}}$。$s\left(r_{j i}\right)$是一个权重函数，用于减少离原子$i$较远的粒子的权重，定义为：</p>
<p>$s\left(r_{j i}\right)&#x3D; \begin{cases}\frac{1}{r_{j i}}, &amp; r_{j i}&lt;r_{c s} \ \frac{1}{r_{j i}}\left{\left(\frac{r_{j i}-r_{c s}}{r_c-r_{c s}}\right)^3\left(-6\left(\frac{r_{j j}-r_{c s}}{r_c-r_{c s}}\right)^2+15 \frac{r_{j j}-r_{c s}}{r_c-r_{c s}}-10\right)+1\right}, &amp; r_{c s}&lt;r_{j i}&lt;r_c,(6) \ 0, &amp; r_{j i}&gt;r_c\end{cases}$</p>
<p>这里$r_{j i}$是原子$i$和$j$之间的欧几里得距离，$r_{c s}$是平滑截止参数。通过引入$s\left(r_{j i}\right)$，$\tilde{\mathcal{R}}^i$中的分量从$r_{c s}$到$r_c$平滑地变为零。然后，$s\left(r_{j i}\right)$，即$\tilde{\mathcal{R}}^i$的第一列，通过嵌入神经网络映射到嵌入矩阵$\mathcal{G}^{i 2} \in \mathbb{R}^{N_i \times M_1}$。通过取$\mathcal{G}^{i 2} \in \mathbb{R}^{N_i \times M_2}$的前$M_2\left(&lt;M_1\right)$列，我们得到另一个嵌入矩阵$\mathcal{G}^{i 2} \in \mathbb{R}^{N_i \times M_2}$。最后，我们定义原子$i$的特征矩阵$\mathcal{G}^{i 2} \in \mathbb{R}^{M_1 \times M_2}$：</p>
<p>$\mathcal{D}^i&#x3D;\left(\mathcal{G}^{i 1}\right)^T \tilde{\mathcal{R}}^i\left(\tilde{\mathcal{R}}^i\right)^T \mathcal{G}^{i 2},(7)$</p>
<p>在特征矩阵中，通过$\tilde{\mathcal{R}}^i\left(\tilde{\mathcal{R}}^i\right)^T$的矩阵乘积保持平移和旋转对称性，并通过$\left(\mathcal{G}^i\right)^T \tilde{\mathcal{R}}^i$的矩阵乘积保持排列对称性。接下来，每个$\mathcal{D}^i$通过拟合网络映射到局部原子能量$E_i$。</p>
<p>嵌入网络$\mathcal{N}^e$和拟合网络$\mathcal{N}^f$都是包含几个隐藏层的前馈神经网络。从前一层的输入数据$d_l^{\text {in }}$到下一层的输出数据$d_k^{\text {out }}$的映射由线性和非线性变换组成。</p>
<p>$d_k^{o u t}&#x3D;\varphi\left(\sum_{k l} w_{k l} d_l^{i n}+b_k\right),(8)$</p>
<p>在等式(8)中，$w_{k l}$是连接权重，$b_k$是偏置权重，$\varphi$是非线性激活函数。需要注意的是，只在输出节点应用线性变换。嵌入和拟合网络中包含的参数是通过最小化损失函数$L$获得的：</p>
<p>$L\left(p_\epsilon, p_f, p_{\xi}\right)&#x3D;\frac{p_\epsilon}{N} \Delta \epsilon^2+\frac{p_f}{3 N} \sum_i\left|\Delta \boldsymbol{F}<em>i\right|^2+\frac{p</em>{\xi}}{9 N}|\Delta \xi|^2,(9)$</p>
<p>其中$\Delta \epsilon, \Delta \boldsymbol{F}<em>i$, 和 $\Delta \xi$分别表示能量、力和应力的均方根误差。在训练过程中，前因子$p_\epsilon, p_f$, 和 $p</em>{\xi}$由以下公式确定</p>
<p>$p(t)&#x3D;p^{\operatorname{limit}}\left[1-\frac{r_l(t)}{r_l^0}\right]+p^{\operatorname{start}}\left[\frac{r_l(t)}{r_l^0}\right]$</p>
<p>其中$r_l(t)$和$r_l^0$分别是训练步骤$t$和训练步骤0的学习率。$r_l(t)$定义为</p>
<p>$r_l(t)&#x3D;r_l^0 \times d_r^{t &#x2F; d_s}$</p>
<p>其中$d_r$和$d_s$分别是衰减率和衰减步骤。衰减率$d_r$需要小于1。有关DeepPot-SE (DP)方法的详细信息，请参阅原始论文。</p>
<h4 id="分子动力学"><a href="#分子动力学" class="headerlink" title="分子动力学"></a>分子动力学</h4><p>分子动力学模拟是一种从微观出发的模拟手段，在科学发现，工程设计等领域具有重要作用。</p>
<p>$\begin{aligned}<br>&amp; m_i \frac{d^2 \boldsymbol{r}_i}{d t^2}&#x3D;-\nabla_i E \<br>&amp; E&#x3D;E\left(\boldsymbol{r}_1, \boldsymbol{r}_2, \ldots, \boldsymbol{r}_N\right)<br>\end{aligned}$</p>
<ul>
<li>计算能量的常见的方式</li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>例子</th>
<th>优缺点</th>
</tr>
</thead>
<tbody><tr>
<td>第一性原理计算密度泛函理论(DFT)</td>
<td>密度泛函理论(DFT)</td>
<td>精度高，计算复杂度高</td>
</tr>
<tr>
<td>计算经验力场</td>
<td>LJ，EAM，MEAM</td>
<td>计算复杂度低，精度不可靠</td>
</tr>
</tbody></table>
<h4 id="DeePKS（电子结构）"><a href="#DeePKS（电子结构）" class="headerlink" title="DeePKS（电子结构）"></a>DeePKS（电子结构）</h4><p><img src="/../images/image-20230701173718442.png" alt="figure"></p>
<!-- <img src="../images/image-20230701173718442.png" alt="image-20230701173718442" style="zoom:67%;" /> -->

<p>满足要求比较好的是<code>单电子的密度矩阵</code>， 然后把波函数投影到一组比较好的<code>完备基</code>上。<br><img src="/../images/image-20230701175149730.png" alt="figure"></p>
<!-- <img src="../images/image-20230701175149730.png" alt="image-20230701175149730" style="zoom:67%;" /> -->



<h4 id><a href="#" class="headerlink" title></a></h4><p><img src="/../images/image-20230701175739715.png" alt="figure"></p>
<!-- <img src="../images/image-20230701175739715.png" alt="image-20230701175739715" style="zoom:67%;" /> -->

<p>构建过程</p>
<p><img src="/../images/image-20230701143507583.png" alt="image-20230701143507583"></p>
<ol>
<li>给定原子坐标， 写出电子结构， 利用DFT计算得到能量， 构建坐标能量对，典型的<code>监督学习</code>，<code>回归</code>问题。</li>
<li>利用DNN来构建<code>体系坐标</code>和<code>能量</code>的关系。</li>
</ol>
<ul>
<li><p>常见的问题： </p>
</li>
<li><ul>
<li>物理约束（旋转性，对称性， 平移， 交换…）</li>
</ul>
</li>
</ul>
<p><img src="/../images/image-20230701143814105.png" alt="figure"></p>
  <!-- <img src="../images/image-20230701143814105.png" alt="image-20230701143814105" style="zoom: 67%;" /> -->

<ul>
<li><p>小原子数量训练得到的在大体系上是否存在问题？</p>
</li>
<li><p>深度势能的构建关系<br>$<br>E&#x3D;\sum_i \mathcal{N}<em>{\alpha_i}\left(\mathcal{D}</em>{\alpha_i}\left(r_i,\left{r_j\right}_{j \in n(i)}\right)\right)<br>$</p>
</li>
</ul>
<p><img src="/../images/image-20230701144137434.png" alt="figure"></p>
<!-- <img src="../images/image-20230701144137434.png" alt="image-20230701144137434" style="zoom: 67%;" /> -->

<p>Function $f\left(x_1, x_2, \ldots x_N\right)$ is permutationally invariant if and only if there exist $\rho$ and $\phi$ such that $f\left(\left{x_i\right}\right)&#x3D;\rho\left(\sum_i \phi\left(x_i\right)\right)$<br>$<br>\mathcal{R}<em>i&#x3D;\left(\begin{array}{cccc}<br>1 &#x2F; r</em>{i 1} &amp; x_{i 1} &#x2F; r_{i 1}^2 &amp; y_{i 1} &#x2F; r_{i 1}^2 &amp; z_{i 1} &#x2F; r_{i 1}^2 \<br>1 &#x2F; r_{i 2} &amp; x_{i 2} &#x2F; r_{i 2}^2 &amp; y_{i 2} &#x2F; r_{i 2}^2 &amp; z_{i 2} &#x2F; r_{i 2}^2 \<br>1 &#x2F; r_{i 3} &amp; x_{i 3} &#x2F; r_{i 3}^2 &amp; y_{i 3} &#x2F; r_{i 3}^2 &amp; z_{i 3} &#x2F; r_{i 3}^2 \</p>
<p>\vdots &amp; \vdots &amp; \vdots &amp; \vdots<br>\end{array}\right) \<br>\mathcal{G}_i&#x3D;\left(\begin{array}{cccc}</p>
<p>G_1\left(r_{i 1}\right)  G_2\left(r_{i 1}\right) &amp; G_3\left(r_{i 1}\right) &amp; \cdots \<br>G_1\left(r_{i 2}\right) &amp; G_2\left(r_{i 2}\right) &amp; G_3\left(r_{i 2}\right) &amp; \cdots \<br>G_1\left(r_{i 3}\right) &amp; G_2\left(r_{i 3}\right) &amp; G_3\left(r_{i 3}\right) &amp; \cdots \<br>\vdots &amp; \vdots &amp; \vdots &amp; \ddots<br>\end{array}\right)<br>$</p>
<blockquote>
<p>R： 环境矩阵， 对于每一个原子来说的， 元素是原子之间的相对距离，所以满足平移相对性， </p>
<p>G： embedding matrix。<br><img src="/../images/image-20230701144137434.png" alt="figure"></p>
</blockquote>
<!-- <img src="../images/image-20230701144805918.png" alt="image-20230701144805918" style="zoom:67%;" /> -->

<p>周期不变：<br>$<br>\mathcal{D}_i&#x3D;\left(\mathcal{G}_i^{&lt;}\right)^T \mathcal{R}_i\left(\mathcal{R}_i\right)^T \mathcal{G}_i<br>$</p>
<p>旋转不变：<br>$<br>\tilde{\mathcal{D}}_i&#x3D;\left(\mathcal{G}_i\right)^T\left(\mathcal{R}_i U\right)\left(\mathcal{R}_i U\right)^T \mathcal{G}_i&#x3D;\left(\mathcal{G}_i\right)^T \mathcal{R}_i U U^T \mathcal{R}_i \mathcal{G}_i&#x3D;\mathcal{D}_i<br>$</p>
<p>神经网络的构建:<br><img src="/../images/image-20230701144137434.png" alt="figure"></p>
<img src="../images/image-20230701145048547.png" alt="image-20230701145048547" style="zoom:67%;">



<h4 id="数据集构建"><a href="#数据集构建" class="headerlink" title="数据集构建"></a>数据集构建</h4><p><img src="/../images/image-20230701145823815.png" alt="image-20230701145823815"></p>
<p><img src="/../images/image-20230701150019764.png" alt="image-20230701150019764"></p>
<p><img src="/../images/image-20230701150243858.png" alt="image-20230701150243858"></p>
<blockquote>
<p>需要保证，大体系结构中的局部体系的结果都在数据集里面有实现。</p>
</blockquote>
<p><img src="/../images/image-20230701150513105.png" alt="image-20230701150513105"></p>
<h3 id="DeePMD-kit-的代码实现"><a href="#DeePMD-kit-的代码实现" class="headerlink" title="DeePMD-kit 的代码实现"></a>DeePMD-kit 的代码实现</h3><p><strong>代码修改</strong>： DeePMD-kit 的代码实现涉及到几个主要部分，包括<code>trainer</code>，<code>model</code>，<code>embedding net</code> 和 <code>fitting net</code>。<code>trainer</code> 部分解析输入 JSON 文件中的参数。<code>model</code> 部分构建操作图，包括<code>type embed net</code>，<code>embedding net</code> 和 <code>fitting net</code>。<code>embedding net</code> 接收环境矩阵 $ \mathcal{R} $ 作为输入，并输出矩阵 $ \mathcal{G} $。<code>fitting net</code> 接收描述符向量作为输入，并输出能量预测。</p>
<p><strong>模型训练的代码</strong>：</p>
<pre><code class="python">class Trainer () :
    def __init__(self, jdata, run_opt):
        # 初始化函数，设置训练参数和运行选项

    def build (self, stop_batch = 0) :
        # 构建训练模型

    def train (self, 
               stop_batch = 0,
               is_init = True, 
               print_iter = 100, 
               save_iter = 1000, 
               save_ckpt = True) :
        # 训练模型的主要函数
        # stop_batch: 停止训练的批次数
        # is_init: 是否初始化模型
        # print_iter: 打印日志的迭代次数
        # save_iter: 保存模型的迭代次数
        # save_ckpt: 是否保存检查点

    def validate (self, 
                  tr_data, 
                  tr_pref) :
        # 验证模型

    def get_feed_dict (self, 
                       batch,
                       is_training) :
        # 获取训练数据的feed字典

    def print_head (self) :
        # 打印训练信息的头部

    def print_info (self, 
                    cur_batch,
                    time,
                    data) :
        # 打印训练信息
</code></pre>
<h3 id="训练和验证"><a href="#训练和验证" class="headerlink" title="训练和验证"></a>训练和验证</h3><p>使用大量的训练数据（原子配置和相应的能量和力）来训练 DeePMD-kit 模型的神经网络。通过最小化模型预测和实际能量和力之间的差异来调整网络的权重。训练完成后，模型需要使用新数据进行验证，以评估其性能。这涉及将模型在训练期间未见过的原子配置输入，并将模型的预测与实际能量和力进行比较。</p>
<h3 id="模拟"><a href="#模拟" class="headerlink" title="模拟"></a>模拟</h3><p>一旦模型经过训练和验证，它就可以用于分子动力学模拟。这是以 Markdown 格式书写的 DeePMD-kit 的概述。这段内容可以粘贴到 Markdown 编辑器或兼容 Markdown 的平台（如 GitHub、Jupyter Notebook等）中，并会被渲染成结构化的文本，包括标题、列表和图片（请注意，图片URL应该被替换为实际的图片链接）。</p>
<div style="page-break-after: always;">
    <button>你好 </button>
</div>


<div style="page-break-after: always;"></div>

<h2 id="图神经网络在-DeePMD-中的应用"><a href="#图神经网络在-DeePMD-中的应用" class="headerlink" title="图神经网络在 DeePMD 中的应用"></a>图神经网络在 DeePMD 中的应用</h2><p>探讨如何使用图神经网络来改进 DeePMD-kit 的性能和精度。</p>
<div style="page-break-after: always;"></div>

<h2 id="应用案例"><a href="#应用案例" class="headerlink" title="应用案例"></a>应用案例</h2><p>展示 DeePMD-kit 在实际问题中的应用，如材料科学和生物分子。</p>
<div style="page-break-after: always;"></div>

<h2 id="性能评估"><a href="#性能评估" class="headerlink" title="性能评估"></a>性能评估</h2><p>评估 DeePMD-kit 的准确性和效率。</p>
<div style="page-break-after: always;"></div>

<h2 id="与其他工具的比较"><a href="#与其他工具的比较" class="headerlink" title="与其他工具的比较"></a>与其他工具的比较</h2><p>将 DeePMD-kit 与其他分子动力学模拟工具进行比较。</p>
<div style="page-break-after: always;"></div>

<h2 id="社区和资源"><a href="#社区和资源" class="headerlink" title="社区和资源"></a>社区和资源</h2><p>介绍 DeePMD-kit 的社区和相关资源，如文档和教程。</p>
<div style="page-break-after: always;"></div>

<h2 id="未来展望"><a href="#未来展望" class="headerlink" title="未来展望"></a>未来展望</h2><p>探讨 DeePMD-kit 的未来发展方向和潜在改进。</p>
<div style="page-break-after: always;"></div>

<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>总结报告的主要发现和结论。</p>
<div style="page-break-after: always;"></div>

<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>列出用于编写报告的参考文献。</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/07/02/DeepMD%E8%AF%A6%E7%BB%86%E5%86%85%E5%AE%B9%E4%BB%8B%E7%BB%8D/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/06/17/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%A1%86%E6%9E%B6/">
        <h2 class="post-title">深度学习框架</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/6/17
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            
            
        </div>
    </div>
    <div class="post-tags">
        
        
    </div>
    <a href="/2023/06/17/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%A1%86%E6%9E%B6/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2023/06/15/%E7%BB%84%E4%BC%9A%E6%B1%87%E6%8A%A5-%E5%88%86%E5%AD%90%E5%B0%BA%E5%BA%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
        <h2 class="post-title">组会汇报-分子尺度深度学习</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/6/15
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <h3 id="基于原子和神经网络方法的精确和高效的过程模拟"><a href="#基于原子和神经网络方法的精确和高效的过程模拟" class="headerlink" title="基于原子和神经网络方法的精确和高效的过程模拟"></a>基于原子和神经网络方法的精确和高效的过程模拟</h3><ul>
<li>作者单位：台积电</li>
</ul>
<blockquote>
<p>这篇论文讨论了一种新的基于机器学习和原子模拟方法的强大研究方法。利用这种方法，作者预测了使用Si2H6（硅烷）前驱体进行硅外延生长的一种先前未被发现的反应序列。这一复杂的表面反应机制通过元动力学模拟揭示出来，它涉及到可控的中间体SiH2的形成过程，解释了在H2载气存在下进行Si2H6吸附时，实验报告中长期未解的生长平台现象。</p>
<p>由于其准确性和灵活的设计，这个工作流模型可以被应用于任何沉积和蚀刻过程条件的优化，以提高薄膜质量，并为下一代电子设备材料提供产量改进的途径。</p>
</blockquote>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p><img src="/../images/image-20230616104936985.png" alt="image-20230616104936985"></p>
<p>利用<code>VASP</code>和<code>DeepMD</code>来构建深度学习， 就是利用前者计算力场，利用后者拟合。</p>
<h4 id="模型训练与验证"><a href="#模型训练与验证" class="headerlink" title="模型训练与验证"></a>模型训练与验证</h4><p><img src="/../images/image-20230616105632564.png" alt="image-20230616105632564"></p>
<ol>
<li><strong>DNN训练数据生成过程</strong></li>
</ol>
<ul>
<li><p>FPMD</p>
<ul>
<li>生成MD轨迹</li>
</ul>
</li>
<li><p>DFT</p>
<ul>
<li>对原子位置和晶格向量进行扰动</li>
</ul>
</li>
<li><p>使用扰动法进行第一个训练周期</p>
</li>
<li><p>主动学习MD方案</p>
<ul>
<li>对大规模、表面和前体吸附配置进行处理</li>
</ul>
</li>
<li><p>验证</p>
<ul>
<li>跟踪训练中的能量和力的误差</li>
<li>对硅的体积电子性质和表面稳定性进行基准测试</li>
</ul>
</li>
</ul>
<ol>
<li><strong>DNN模型基准测试过程</strong></li>
</ol>
<ul>
<li><p>声子特性</p>
<ul>
<li>在声子色散和态密度中捕获关键的声子特性</li>
</ul>
</li>
<li><p>原子位移演化</p>
<ul>
<li>跟踪顶层原子的原子位移</li>
</ul>
</li>
<li><p>表面重构</p>
<ul>
<li>进行表面重构</li>
</ul>
</li>
</ul>
<p>简而言之，利用vasp计算原子模型得到的能量&#x2F;受力，然后拟合这两者关系得到力场。</p>
<p><strong>VASP计算</strong></p>
<p>定义<code>INCAR(定义计算内容， 类似config，计算能量/受力)</code>, <code>POSCAR(给出原子模型)</code>两个文件， 自动生成<code>POTCAR(pseudopotential)</code>， 基于此，进行计算， 结果保存在<code>OUTCAR</code>里面。</p>
<ul>
<li>INCAR</li>
</ul>
<pre><code class="bASH">Collinear Magnetic Calculation
ISPIN      =  2        (Spin polarised DFT)
MAGMOM   =  -4 -4 -4 -4 -4 -4 -4 -4 4 4 4 4 4 4 4 4 4 4 2*4 2*4 2*4 31*0.5         (Set this parameters manually)
LASPH      = .TRUE.    (Non-spherical elements; d/f convergence)
GGA_COMPAT = .FALSE.   (Apply spherical cutoff on gradient field)
VOSKOWN    =  1        (Enhances the magnetic moments and the magnetic energies)
LMAXMIX    =  4        (For d elements increase LMAXMIX to 4, f: LMAXMIX = 6)
AMIX       =  0.2    (Mixing parameter to control SCF convergence)
BMIX       =  0.0001 (Mixing parameter to control SCF convergence)
AMIX_MAG   =  0.4    (Mixing parameter to control SCF convergence)
BMIX_MAG   =  0.0001 (Mixing parameter to control SCF convergence)

 
DFT+U Calculation
LDAU   = .TRUE.        (Activate DFT+U)
LDATYPE=  2            (Dudarev; only U-J matters)
LDAUL  =  2  2  2  2  -1       (Orbitals for each species)
LDAUU  =  4  4  4  4  0       (U for each species)
LDAUJ  =  0.5  0.5  0.5  0.5  0       (J for each species)
LMAXMIX=  4            (Mixing cut-off; 4-d, 6-f)

 
Global Parameters
ISTART =  1            (Read existing wavefunction; if there)
# ISPIN =  2           (Spin polarised DFT)
# ICHARG =  11         (Non-self-consistent: GGA/LDA band structures)
LREAL  = Auto          (Projection operators: automatic)
ENCUT  =  600        (Cut-off energy for plane wave basis set, in eV)
PREC   =  Normal       (Precision level)
LWAVE  = .TRUE.        (Write WAVECAR or not)
LCHARG = .TRUE.        (Write CHGCAR or not)
ADDGRID= .TRUE.        (Increase grid; helps GGA convergence)
# LVTOT  = .TRUE.      (Write total electrostatic potential into LOCPOT or not)
# LVHAR  = .TRUE.      (Write ionic + Hartree electrostatic potential into LOCPOT or not)
# NELECT =             (No. of electrons: charged cells; be careful)
# LPLANE = .TRUE.      (Real space distribution; supercells)
# NPAR   = 4           (Max is no. nodes; don&#39;t set for hybrids)
# NWRITE = 2           (Medium-level output)
# KPAR   = 2           (Divides k-grid into separate groups)
# NGX    = 500         (FFT grid mesh density for nice charge/potential plots)
# NGY    = 500         (FFT grid mesh density for nice charge/potential plots)
# NGZ    = 500         (FFT grid mesh density for nice charge/potential plots)

Electronic Relaxation
ISMEAR =  0            (Gaussian smearing; metals:1)
SIGMA  =  0.05         (Smearing value in eV; metals:0.2)
NELM   =  200           (Max electronic SCF steps)
#NELMIN =  6            (Min electronic SCF steps)
EDIFF  =  1E-04        (SCF energy convergence; in eV)
# GGA  =  PS           (PBEsol exchange-correlation)

Ionic Relaxation
NSW    =  200          (Max ionic steps)
IBRION =  2            (Algorithm: 0-MD; 1-Quasi-New; 2-CG)
ISIF   =  2            (Stress/relaxation: 2-Ions, 3-Shape/Ions/V, 4-Shape/Ions)
EDIFFG = -5E-02        (Ionic convergence; eV/AA)

Other Sets
#ISYM = 0
LORIBT = 11
LREAL = auto
LDIPOL = .TRUE.
IDIPOL = 3 
</code></pre>
<ul>
<li>POSCAR</li>
</ul>
<pre><code class="bash"> result1\(-1\0\0)\(2)                   
   1.00000000000000     
     8.4650001526000000    0.0000000000000000    0.0000000000000000
     0.0000000000000000    8.4650001526000000    0.0000000000000000
     0.0000000000000000    0.0000000000000000   22.4559993744000010
   Fe   Mn   Co   Ni   O 
    18     2     2     2    31
Selective dynamics
Direct
      0.91149922       0.93394451       0.30298449   T  T  T 
      0.54928124       0.56044684       0.29732690   T  T  T 
      0.00078665       0.50685843       0.14280074   T  T  T 
      0.50100867      -0.00087781       0.14336777   T  T  T 
      0.74966002       0.24499001       0.04966000   F  F  F 
      0.25306246       0.24622419       0.24308685   T  T  T 
      0.75646493       0.73886826       0.23682094   T  T  T 
      0.24959000       0.74254000       0.04955000   F  F  F 
      0.36362551       0.88939961       0.28422896   T  T  T 
      0.37275001       0.37446999       0.09679000   F  F  F 
      0.62655997       0.87489003       0.00145000   F  F  F 
      0.88892126       0.37871634       0.27967138   T  T  T 
      0.12474000       0.37724000       0.00286000   F  F  F 
      0.13537451       0.87019407       0.19315328   T  T  T 
      0.87775999       0.87234002       0.09593000   F  F  F 
      0.61822538       0.36499678       0.19073725   T  T  T 
      0.37485999       0.12455000       0.00229000   F  F  F 
      0.12609001       0.12396000       0.09679000   F  F  F 
      0.87503127       0.12539944       0.19149679   T  T  T 
      0.62344003       0.62557000       0.09738000   F  F  F 
      0.87712997       0.62597001       0.00195000   F  F  F 
      0.61720147       0.11961980       0.28503860   T  T  T 
      0.36775063       0.62527783       0.19060239   T  T  T 
      0.11978615       0.61702653       0.28201958   T  T  T 
      0.38083549       0.37785134       0.19095691   T  T  T 
      0.88235998       0.11405000       0.09627000   F  F  F 
      0.66019525       0.87924509       0.29268959   T  T  T 
      0.12107000       0.61469001       0.00023000   F  F  F 
      0.35538812       0.65701680       0.28963690   T  T  T 
      0.86782998       0.87575001       0.00517000   F  F  F 
      0.13143000       0.37704000       0.09430000   F  F  F 
      0.62352750       0.13241024       0.19208011   T  T  T 
      0.36914000       0.13489001       0.09718000   F  F  F 
      0.12902930       0.63325776       0.19266269   T  T  T 
      0.87686175       0.60810064       0.28978881   T  T  T 
      0.11830000       0.87140000       0.09951000   F  F  F 
      0.61862999       0.11504000       0.00147000   F  F  F 
      0.88683371       0.87465383       0.18953353   T  T  T 
      0.37419000       0.61343998       0.09935000   F  F  F 
      0.11465552       0.38072686       0.28473890   T  T  T 
      0.85682220       0.15173567       0.29227789   T  T  T 
      0.36780000       0.37867001       0.00566000   F  F  F 
      0.63459998       0.87900001       0.09384000   F  F  F 
      0.87550002       0.63556999       0.09510000   F  F  F 
      0.11433896       0.85777596       0.28410816   T  T  T 
      0.38352337       0.11589898       0.28979767   T  T  T 
      0.61631000       0.37123001       0.10025000   F  F  F 
      0.88268000       0.37531999       0.00032000   F  F  F 
      0.61149357       0.60937161       0.19422251   T  T  T 
      0.36969135       0.86804908       0.18981720   T  T  T 
      0.13167000       0.13587000       0.00198000   F  F  F 
      0.63001001       0.63647002       0.00231000   F  F  F 
      0.12931348       0.11474703       0.18829403   T  T  T 
      0.38371000       0.87102997       0.00000000   F  F  F 
      0.86592531       0.37820479       0.19126102   T  T  T 
</code></pre>
<p><img src="/../images/image-20230616111122830.png" alt="image-20230616111122830"></p>
<p><strong>DeepMD计算</strong></p>
<ul>
<li>原理</li>
<li>原子的能量可以有临近的环境决定(截断半径$R_c$的大小。)</li>
</ul>
<p>$$<br>E &#x3D; \sum_{i} E_{i}<br>$$</p>
<ul>
<li>$E_i$ 的构建步骤：</li>
</ul>
<ol>
<li>首先构造一个新的坐标系用于保持环境的平移、旋转和置换对称：</li>
</ol>
<p><img src="/../images/image-20230617144548185.png" alt="image-20230617144548185"></p>
<ol start="2">
<li>新坐标系的$D_{ij}$ 作为DNN神经网络的输入用于求解$E_i$, 这里采用的是<code>MLP</code>神经网络</li>
</ol>
<p><img src="/../images/image-20230617144909939.png" alt="image-20230617144909939"></p>
<ol start="3">
<li>基于<code>Adam</code>优化算法来进行优化， 定义损失函数如下：</li>
</ol>
<p>$$<br>L\left(p_\epsilon, p_f, p_{\xi}\right)&#x3D;p_\epsilon \Delta \epsilon^2+\frac{p_f}{3 N} \sum_i\left|\Delta \boldsymbol{F}<em>i\right|^2+\frac{p</em>{\xi}}{9}|\Delta \xi|^2<br>$$</p>
<blockquote>
<p>$\Delta$：这个表示DPMD（Deep Potential Molecular Dynamics）预测与训练数据之间的差异。这个差异可能会被用来计算模型的损失函数，以便在训练过程中调整模型的参数。</p>
<p>$N$：这个表示原子的数量。在物理和化学的模拟中，这个参数通常用来表示系统的大小或复杂性。</p>
<p>$\epsilon$：这个表示每个原子的能量。在物理和化学的模拟中，这个参数通常用来表示系统的总能量或者能量分布。</p>
<p>$\boldsymbol{F}_i$：这个表示作用在第$i$个原子上的力。在分子动力学模拟中，这个参数通常用来计算原子的运动。</p>
<p>$\xi$：这个表示单位原子的”virial tensor”（或称为”维里张量”），它定义为$\Xi&#x3D;-\frac{1}{2} \sum_i \boldsymbol{R}_i \otimes \boldsymbol{F}_i$，然后除以原子的数量$N$。维里张量是一个描述系统压力和体积变化关系的物理量。</p>
<p>$p_\epsilon, p_f$, 和 $p_{\xi}$：这些是可调的预因子（prefactors），它们可以在训练过程中调整，以达到最小化损失函数的目标。当数据中缺少virial信息时，我们设定$p_{\xi}&#x3D;0$。在训练过程中，我们逐渐增大$p_\epsilon$和$p_{\xi}$，同时减小$p_f$，以确保在训练开始时，力的项占主导，而在训练结束时，能量和virial项变得重要。</p>
</blockquote>
<p>基于前面<code>VASP</code> 计算得到的数据，便可以开始训练力场了。</p>
<p><img src="/../images/image-20230616115654284.png" alt="image-20230616115654284"></p>
<p>之前配置的内容：</p>
<pre><code class="python">&#123;
    &quot;model&quot;: &#123;
        &quot;type_map&quot;:                [&quot;Ca&quot;,&quot;Si&quot;,&quot;O&quot;,&quot;H&quot;],
        &quot;descriptor&quot; :&#123;
            &quot;type&quot;:                &quot;se_a&quot;,
            &quot;sel&quot;:                 [30,30,90,70],
            &quot;rcut_smth&quot;:           6.80,
            &quot;rcut&quot;:                7.00,
            &quot;neuron&quot;:              [25, 50, 100],
            &quot;resnet_dt&quot;:           false,
            &quot;axis_neuron&quot;:         16,
            &quot;seed&quot;:                1
        &#125;,
        &quot;fitting_net&quot; : &#123;
            &quot;neuron&quot;:              [40,40,40],
            &quot;resnet_dt&quot;:           true,
            &quot;coord_norm&quot;:          true,
            &quot;type_fitting_net&quot;:    false,
            &quot;seed&quot;:                1
        &#125;
    &#125;,
    &quot;loss&quot;: &#123;
        &quot;start_pref_e&quot;:            0.02,
        &quot;limit_pref_e&quot;:            1,
        &quot;start_pref_f&quot;:            1000,
        &quot;limit_pref_f&quot;:            1,
        &quot;start_pref_v&quot;:            0,
        &quot;limit_pref_v&quot;:            0
    &#125;,
    &quot;learning_rate&quot;: &#123;
        &quot;type&quot;:                    &quot;exp&quot;,
        &quot;decay_steps&quot;:             5000,
        &quot;start_lr&quot;:                0.001,
        &quot;stop_lr&quot;:                 3.51e-9
    &#125;,
    &quot;training&quot;: &#123;
        &quot;systems&quot;:                 [数据集路径],
        &quot;set_prefix&quot;:              &quot;set&quot;,
        &quot;stop_batch&quot;:              500000,
        &quot;batch_size&quot;:              1,
        &quot;seed&quot;:                    1,
        &quot;_comment&quot;:                &quot;frequencies counted in batch&quot;,
        &quot;disp_file&quot;:               &quot;lcurve.out&quot;,
        &quot;disp_freq&quot;:               100,
        &quot;numb_test&quot;:               50,
        &quot;save_freq&quot;:               1000,
        &quot;save_ckpt&quot;:               &quot;model.ckpt&quot;,
        &quot;load_ckpt&quot;:               &quot;model.ckpt&quot;,
        &quot;disp_training&quot;:           true,
        &quot;time_training&quot;:           true,
        &quot;profiling&quot;:               false,
        &quot;profiling_file&quot;:          &quot;timeline.json&quot;
    &#125;
&#125;
</code></pre>
<p>![320_320_320_lcurve](F:&#x2F;深度势能&#x2F;fitting Network&#x2F;all_lcurve_data&#x2F;320_320_320_lcurve.jpg)</p>
<p>![神经元与训练误差的关系](F:&#x2F;深度势能&#x2F;fitting Network&#x2F;all_lcurve_data&#x2F;神经元与训练误差的关系.png)</p>
<h4 id="结果讨论"><a href="#结果讨论" class="headerlink" title="结果讨论"></a>结果讨论</h4><ul>
<li>SiH$_4$和Si$_2$H$_6$吸附的反应动力学。</li>
</ul>
<p><img src="/../images/image-20230616111449593.png" alt="image-20230616111449593"></p>
<ol>
<li><strong>自由能表面（FES）计算</strong>：该表面描述了化学反应的空间。它是通过使用元动力学模拟和增强采样方法来计算的。元动力学模拟是一种计算方法，可以帮助研究者对复杂系统的自由能表面进行建模和分析。</li>
<li><strong>高斯山（Gaussian hills）</strong>：整个势能表面是通过随机添加潜在能量（“高斯山”）来采样的。高斯山是元动力学模拟中的一个重要概念，用于改变势能表面，以提高探索率并避免陷入局部最小值。</li>
<li><strong>集体变量（CVs）选择</strong>：选择集体变量是一个关键的决策步骤，它需要确保对整个前体吸附过程的准确和有效的物理预测。集体变量是元动力学模拟中的一个重要概念，它表示系统中重要的、可变的参数。</li>
<li><strong>SiH4吸附</strong>：文本描述了SiH4吸附过程中的关键反应中间体和激活能。这些结果与之前的模拟结果相符。</li>
<li><strong>Si2H6吸附</strong>：在温度低于700K时，Si2H6吸附的速率限制步骤是第一个反应*H + Si2H5，其中一个氢被转移到表面，激活能为0.34 eV。</li>
<li><strong>Si2H6气相分解</strong>：在温度高于700K时，Si2H6的分解过程包括生成SiH2和SiH4的中间产品以及Si2H4和H2气体，它们的激活能都约为2 eV。实验表明，SiH2产品容易在36.5 Torr和720 K的条件下在表面上吸附。</li>
</ol>
<h3 id="硅生长的新反应机制揭示"><a href="#硅生长的新反应机制揭示" class="headerlink" title="硅生长的新反应机制揭示"></a>硅生长的新反应机制揭示</h3><p><strong>氢脱附的可能的其他的反应途径</strong></p>
<ul>
<li><strong>氢解吸的替代反应路径</strong>：这个替代反应路径在图10中以示意图的形式描绘。解吸是吸附过程的逆过程，也就是说，吸附到物质表面的粒子离开表面并回到气相。</li>
</ul>
<p><img src="/../images/image-20230616112412823.png" alt="image-20230616112412823"></p>
<ul>
<li><strong>文献中的氢解吸路径</strong>：通常文献中讨论的氢解吸路径涉及到两个表面氢（surface H）。表面氢是指已经吸附在物质表面上的氢原子。</li>
<li><strong>表面氢和前驱体氢的相互作用</strong>：然而，表面氢与前驱体氢的相互作用产生了更低的活化能。这个过程在图11中展示。活化能是一种反应需要的能量，更低的活化能意味着反应更容易进行。</li>
</ul>
<p><img src="/../images/image-20230616112437013.png" alt="image-20230616112437013"></p>
<ul>
<li><strong>影响因素</strong>：当前驱体或载气流量增加时，这个具有较低活化能的过程可能更容易发生。这意味着，通过改变前驱体或载气的流量，可以影响这个反应过程。</li>
</ul>
<p>分解产物SiH2的吸附</p>
<ol>
<li><strong>SiH2的吸附</strong>：通过DPMD研究预测，SiH2可以在无阻力的过程中自发地吸附在Si表面（图9，公式4）。当活化能Ea&#x3D; 0 eV时，根据阿伦尼乌斯方程，SiH2在大于700 K的温度范围内的吸附速度是常数，这导致生长速率呈现出一个平台阶段。</li>
</ol>
<p><img src="/../images/image-20230616113051079.png" alt="image-20230616113051079"></p>
<ol>
<li><strong>Si的生长过程</strong>：为了全面了解从低温到高温的Si生长过程，计算了所有可能的表面反应作为表面氢覆盖率的函数（图11）。反应速率在SiH4、Si2H6和SiH2吸附，H2吸附和所有已知H解吸路径中被提取出来（图12）。由于SiH2的吸附没有活化障碍，其数据被放置在水平轴上。</li>
</ol>
<p><img src="/../images/image-20230616113136130.png" alt="image-20230616113136130"></p>
<ol>
<li><strong>Si生长的模拟</strong>：模拟了通过Si2H6沉积生长Si的过程，这也支持了之前提出的在低温和高温区间存在明显分界线的观点（图13）。在低温区，根据图11和图12，H的解吸被证实为速率限制步骤。当温度适度增加时，H表面覆盖率略有降低，而可供前驱体吸附的Si表面积增加，因此Si的生长速率随温度的升高而增加。</li>
</ol>
<p><img src="/../images/image-20230616113146211.png" alt="image-20230616113146211"></p>
<ol>
<li><strong>高温区的特性</strong>：在约700 K，Si2H6在气相中开始分解，生成SiH2和SiH4。因为SiH2在Si表面的吸附是无阻力的过程，所以它在中温和高温区域占主导，引起了生长速率的“恒定”并定义了低温和高温机制之间的“交叉点”（图13）。此外，SiH2吸附产生表面SiH键，SiH（0.7 eV）或H（0.5 eV）的小表面扩散障碍在大于700 K可热力学上实现，促进了表面重排和加速了H2的解吸（图14）。</li>
</ol>
<p><img src="/../images/image-20230616113202942.png" alt="image-20230616113202942"></p>
<ol>
<li><strong>更高温度下的行为</strong>：在大约840 K的高温开始，表面H覆盖率显著降低，任何前驱体或产品（SiH4，Si2H6，或SiH2）都可以直接在表面沉积，直到约1100 K生长速率“饱和”，系统进入由前驱体流速限制的阶段。</li>
</ol>
<h4 id="总体研究步骤"><a href="#总体研究步骤" class="headerlink" title="总体研究步骤"></a>总体研究步骤</h4><ol>
<li><p><strong>建立反应模型</strong>：研究者首先定义了一个包含SiH4等分子的系统。这个系统可能包括了所有可能的反应参与者和环境条件。</p>
</li>
<li><p><strong>拟合势能面</strong>：DeepMD是一种基于深度学习的势能面拟合方法。这个模型使用一组从量子力学计算得到的数据作为训练集，这些数据可能包括原子间的距离、角度、能量等信息。DeepMD模型通过训练学习这些数据的特征，拟合出整个反应系统的势能面。在拟合过程中，DeepMD模型能够学习到各种原子间的相互作用，从而精确地模拟复杂的反应过程。</p>
</li>
<li><p><strong>搜索反应路径</strong>：在得到势能面后，研究者就可以在这个势能面上搜索反应路径。这通常是通过启动分子动力学模拟来完成的。模拟过程中，系统会在势能面上进行演化，寻找从反应物到产物的最低能量路径。这个过程可以揭示反应的过渡态（Transition State），也就是反应路径上的能量最大点。</p>
<ul>
<li><p><strong>力场（势能面）的建立</strong>：在量子力学级别上进行高精度的力场参数化，使用深度学习算法（如DeepMD）训练并拟合出描述分子内部和分子间相互作用的势能面。这个过程需要大量的量子力学计算数据，包括不同原子构型下的能量、力等。经过训练，DeepMD模型将能够对新的原子构型给出相应的势能和力的预测。</p>
</li>
<li><p><strong>分子动力学模拟</strong>：利用上一步拟合得到的势能面（力场），进行分子动力学模拟。这个过程中，分子在力场的驱动下进行运动，经过一段时间后，可以获得反应的动态过程。通过分析模拟得到的轨迹，可以找到反应的过渡态、中间产物，以及反应速率等信息，从而揭示反应的详细机理。</p>
</li>
</ul>
</li>
<li><p><strong>揭示反应机理</strong>：通过对反应路径的分析，研究者可以揭示反应的详细机理。这可能包括反应的中间态、过渡态以及反应的速率常数等信息。例如，SiH4分子在反应过程中可能会经历一系列的断裂和形成，通过分析这些信息，研究者可以得出SiH4分子在反应过程中的详细行为，从而了解其反应机理。</p>
</li>
</ol>

            
        </div>
    </div>
    <div class="post-tags">
        
        <span class="icon">
            <i class="fa-solid fa-tags fa-fw"></i>
        </span>
        
        
        <span class="tag">
            
            <a href="/tags/%E5%88%86%E5%AD%90%E5%B0%BA%E5%BA%A6%EF%BC%8C-%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="color: #00bcd4">分子尺度， 深度学习</a>
        </span>
        
    </div>
    <a href="/2023/06/15/%E7%BB%84%E4%BC%9A%E6%B1%87%E6%8A%A5-%E5%88%86%E5%AD%90%E5%B0%BA%E5%BA%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" class="go-post">阅读全文</a>
</div>


        <div class="page-current">
    <div class="prev">
        
    </div>
    <div class="page-index">
        
        <span class="current">1</span>
        
        <span>
            <a class="page-num" href="/page/2/">2</a>
            
            
        </span>
        
    </div>
    <div class="next">
        
        <a class="page-num" href="/page/2/">
            <i class="fa-solid fa-caret-right fa-fw"></i>
        </a>
        
    </div>
</div>

    </div>
    
    <div id="home-card">
        <div id="card-div">
    <div class="card-style">
        <div class="avatar">
            <img src="/images/avatar.gif" alt="avatar" />
        </div>
        <div class="name">Ding Li</div>
        <div class="description">
            <p>Description<br>你好， 这里是Linkedlist771的个人博客，主要记录一些学习笔记，谢谢你的访问！</p>

        </div>
        
        <div class="icon-links">
            
            <span class="icon-link">
                <a target="_blank" rel="noopener" href="https://github.com/linkedlist771">
                    <i
                        class="fa-brands fa-github fa-fw"
                    ></i>
                </a>
            </span>
            
            <span class="icon-link">
                <a href="/null">
                    <i
                        class="fa-brands fa-twitter fa-fw"
                    ></i>
                </a>
            </span>
            
            <span class="icon-link">
                <a target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&uin=2317431442&site=qq&menu=yes">
                    <i
                        class="fa-brands fa-qq fa-fw"
                    ></i>
                </a>
            </span>
            
            <span class="icon-link">
                <a href="mailto:213193509seu@gmail.com">
                    <i
                        class="fa-solid fa-envelope fa-fw"
                    ></i>
                </a>
            </span>
            
        </div>
        
        
        <div class="friend-links">
            
            <div class="friend-link">
                <a target="_blank" rel="noopener" href="https://argvchs.github.io">Argvchs</a>
            </div>
            
            <div class="friend-link">
                <a href="/www.803366.xyz">Stmoonar</a>
            </div>
            
        </div>
        
    </div>
</div>

    </div>
    
</div>

                    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2023 LinkedList&#39;s Blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Ding Li
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

                </div>
            </transition>
            
            <transition name="fade">
                <div id="preview" ref="preview" v-show="previewShow">
                    <img id="preview-content" ref="previewContent" />
                </div>
            </transition>
            
        </div>
        <script src="/js/main.js"></script>
        
    </body>
</html>
