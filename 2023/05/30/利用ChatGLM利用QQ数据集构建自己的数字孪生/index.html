
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <title>åˆ©ç”¨ChatGLMåˆ©ç”¨QQæ•°æ®é›†æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿ | LinkedList&#39;s Blog</title>
        <meta name="author" content="Ding Li" />
        <meta name="description" content="This is blog for Linkedlist771, mainly record some learning notes, thank you for your visit!" />
        <meta name="keywords" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <link rel="icon" href="/images/favicon.png" />
        <script src="https://cdn.staticfile.org/vue/3.2.47/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.3.0/css/all.min.css" />
<link rel="stylesheet" href="/css/fonts.min.css" />
<script> const mixins = {}; </script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://cdn.staticfile.org/KaTeX/0.16.4/katex.min.js"></script>
<script src="https://cdn.staticfile.org/KaTeX/0.16.4/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.16.4/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

    <meta name="generator" content="Hexo 6.3.0"></head>
    <body>
        <div id="layout">
            <transition name="fade">
                <div id="loading" v-show="loading">
                    <div id="loading-circle">
                        <h2>LOADING</h2>
                        <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜ æµè§ˆå™¨é»˜è®¤å¼€å¯</p>
                        <img src="/images/loading.gif" />
                    </div>
                </div>
            </transition>
            <nav id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <div id="desktop-menu">
        <a class="title" href="/">
            <span>LINKEDLIST&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;LINKEDLIST&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </div>
</nav>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

            <transition name="into">
                <div id="main" v-show="!loading">
                    <div class="article">
    <div>
        <h1>åˆ©ç”¨ChatGLMåˆ©ç”¨QQæ•°æ®é›†æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿ</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/5/30
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/tags/ChatGLM%EF%BC%8C-%E6%95%B0%E5%AD%97%E5%AD%AA%E7%94%9F%EF%BC%8C-QQ%E6%95%B0%E6%8D%AE%E9%9B%86/" style="color: #03a9f4">ChatGLMï¼Œ æ•°å­—å­ªç”Ÿï¼Œ QQæ•°æ®é›†</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h3 id="é¡¹ç›®ç®€ä»‹ï¼š"><a href="#é¡¹ç›®ç®€ä»‹ï¼š" class="headerlink" title="é¡¹ç›®ç®€ä»‹ï¼š"></a>é¡¹ç›®ç®€ä»‹ï¼š</h3><p>æœ¬é¡¹ç›®æºè‡ª<a target="_blank" rel="noopener" href="https://github.com/kcxain/CloneLLM">kcxain</a>, æœ¬äººåªæ˜¯å°†å…¶åœ¨æœ¬åœ°éƒ¨ç½²å®Œæˆï¼Œ ä½œè€…ä½¿ç”¨äº†<code>NVIDIA A100 80GB</code> å¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½æ‹¥æœ‰çš„ã€‚ä¹Ÿä¸æ˜¯æ¯ä¸€ä¸ªäººéƒ½æ‹¥æœ‰<code>Linux</code>ç³»ç»Ÿè¿›è¡Œéƒ¨ç½²ï¼Œå¹¶ä¸”å¯¹äº<code>ChatGLM</code>çš„éƒ¨ç½²ï¼Œä½œè€…æ²¡æœ‰è¯´çš„å¾ˆæ˜ç™½ã€‚æ‰€ä»¥è¿™ä¸ªé¡¹ç›®å°†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><code>ChatGLM</code>çš„éƒ¨ç½²</li>
<li>åŸºäºè¯¥é¡¹ç›®çš„è‡ªæˆ‘æ•°æ®é›†çš„è®­ç»ƒ</li>
</ol>
<h3 id="ChatGLMéƒ¨ç½²"><a href="#ChatGLMéƒ¨ç½²" class="headerlink" title="ChatGLMéƒ¨ç½²"></a>ChatGLMéƒ¨ç½²</h3><ul>
<li>ChatGLM-6B æ˜¯ä¸€ä¸ªå¼€æºçš„ã€æ”¯æŒä¸­è‹±åŒè¯­çš„å¯¹è¯è¯­è¨€æ¨¡å‹ï¼ŒåŸºäº General Language Model (GLM) æ¶æ„ï¼Œå…·æœ‰ 62 äº¿å‚æ•°<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
<li>ç»“åˆæ¨¡å‹é‡åŒ–æŠ€æœ¯ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ¶ˆè´¹çº§çš„æ˜¾å¡ä¸Šè¿›è¡Œæœ¬åœ°éƒ¨ç½²ï¼ˆINT4 é‡åŒ–çº§åˆ«ä¸‹æœ€ä½åªéœ€ 6GB æ˜¾å­˜ï¼‰<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
<li>ChatGLM-6B ä½¿ç”¨äº†å’Œ ChatGPT ç›¸ä¼¼çš„æŠ€æœ¯ï¼Œé’ˆå¯¹ä¸­æ–‡é—®ç­”å’Œå¯¹è¯è¿›è¡Œäº†ä¼˜åŒ–<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
<li>ç»è¿‡çº¦ 1T æ ‡è¯†ç¬¦çš„ä¸­è‹±åŒè¯­è®­ç»ƒï¼Œè¾…ä»¥ç›‘ç£å¾®è°ƒã€åé¦ˆè‡ªåŠ©ã€äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ ç­‰æŠ€æœ¯çš„åŠ æŒï¼Œ62 äº¿å‚æ•°çš„ ChatGLM-6B å·²ç»èƒ½ç”Ÿæˆç›¸å½“ç¬¦åˆäººç±»åå¥½çš„å›ç­”<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
<li>ä¸ºäº†æ–¹ä¾¿ä¸‹æ¸¸å¼€å‘è€…é’ˆå¯¹è‡ªå·±çš„åº”ç”¨åœºæ™¯å®šåˆ¶æ¨¡å‹ï¼Œä»–ä»¬åŒæ—¶å®ç°äº†åŸºäº P-Tuning v2 çš„é«˜æ•ˆå‚æ•°å¾®è°ƒæ–¹æ³• (ä½¿ç”¨æŒ‡å—) ï¼ŒINT4 é‡åŒ–çº§åˆ«ä¸‹æœ€ä½åªéœ€ 7GB æ˜¾å­˜å³å¯å¯åŠ¨å¾®è°ƒ<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
<li>ChatGLM-6B å¼€æºæ¨¡å‹æ—¨åœ¨ä¸å¼€æºç¤¾åŒºä¸€èµ·æ¨åŠ¨å¤§æ¨¡å‹æŠ€æœ¯å‘å±•ï¼Œæ³è¯·å¼€å‘è€…å’Œå¤§å®¶éµå®ˆå¼€æºåè®®ï¼Œå‹¿å°†å¼€æºæ¨¡å‹å’Œä»£ç åŠåŸºäºå¼€æºé¡¹ç›®äº§ç”Ÿçš„è¡ç”Ÿç‰©ç”¨äºä»»ä½•å¯èƒ½ç»™å›½å®¶å’Œç¤¾ä¼šå¸¦æ¥å±å®³çš„ç”¨é€”ä»¥åŠç”¨äºä»»ä½•æœªç»è¿‡å®‰å…¨è¯„ä¼°å’Œå¤‡æ¡ˆçš„æœåŠ¡<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
</ul>
<p>æ¸…åçš„ ChatGLM é¡¹ç›®åœ¨ 2023 å¹´ä¹Ÿå‘å¸ƒäº†ä¸€äº›é‡è¦çš„æ›´æ–°ï¼š</p>
<ul>
<li>2023 å¹´ 5 æœˆ 17 æ—¥ï¼Œä»–ä»¬å‘å¸ƒäº† VisualGLM-6Bï¼Œä¸€ä¸ªæ”¯æŒå›¾åƒç†è§£çš„å¤šæ¨¡æ€å¯¹è¯è¯­è¨€æ¨¡å‹<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
<li>2023 å¹´ 5 æœˆ 15 æ—¥ï¼Œä»–ä»¬æ›´æ–°äº† v1.1 ç‰ˆæœ¬ checkpointï¼Œè®­ç»ƒæ•°æ®å¢åŠ è‹±æ–‡æŒ‡ä»¤å¾®è°ƒæ•°æ®ä»¥å¹³è¡¡ä¸­è‹±æ–‡æ•°æ®æ¯”ä¾‹ï¼Œè§£å†³è‹±æ–‡å›ç­”ä¸­å¤¹æ‚ä¸­æ–‡è¯è¯­çš„ç°è±¡<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">1</a>ã€‚</li>
</ul>
<h4 id="éƒ¨ç½²ChatGLM"><a href="#éƒ¨ç½²ChatGLM" class="headerlink" title="éƒ¨ç½²ChatGLM"></a>éƒ¨ç½²ChatGLM</h4><ol>
<li><p>è¿›å…¥<a target="_blank" rel="noopener" href="https://github.com/THUDM/ChatGLM-6B">ChatGLM</a> ä¸»é¡µï¼Œæ‰¾åˆ°gité“¾æ¥ï¼Œgitåˆ°æœ¬åœ°å³å¯:</p>
<p><img src="/../images/image-20230530173507682.png" alt="image-20230530173507682"></p>
<p>ç„¶åä½¿ç”¨git å‘½ä»¤ä¸‹è½½åˆ°æœ¬åœ°å³å¯ï¼š</p>
<pre><code class="bash">git clone git@github.com:THUDM/ChatGLM-6B.git
</code></pre>
<p>å¦‚æœä¸ç†Ÿæ‚‰gitï¼Œ ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸»é¡µçš„ä¸‹è½½æŒ‰é’®ä¸‹è½½zipæ–‡ä»¶è¿›è¡Œè§£å‹ã€‚</p>
<p><img src="/../images/image-20230530173631415.png" alt="image-20230530173631415"></p>
</li>
<li><p>ä¸‹è½½å®ŒChatGLMä¸»é¡µç¨‹åºåï¼Œç°åœ¨éœ€è¦ä¸‹è½½æ¨¡å‹çš„æƒé‡æ–‡ä»¶ã€‚è¿›å…¥ChatGLMçš„<a target="_blank" rel="noopener" href="https://huggingface.co/THUDM/chatglm-6b">hugging face hub</a></p>
<p>åˆ©ç”¨æŒ‰ç…§ä¸»é¡µæ•™ç¨‹åˆ©ç”¨git lsf è¿›è¡Œä¸‹è½½å³å¯ã€‚ </p>
<p>å¦‚æœè¿™ä¸€æ­¥ä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å…ˆä¸‹è½½é¡¹ç›®æ–‡ä»¶ï¼Œ å°†æƒé‡æ–‡ä»¶ä¸‹è½½å¹¶ä¿å­˜è¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„å…¶ä»–çš„æ–‡ä»¶åˆ°chatglm-6bæ–‡ä»¶å¤¹ï¼ˆ<code>æ³¨æ„ï¼Œè¯¥æ–‡ä»¶å¤¹è¦åœ¨ä¹‹å‰çš„ChatGLMæ–‡ä»¶å¤¹ä¸‹</code>ï¼‰ï¼š</p>
<p><img src="/../images/image-20230530174240127.png" alt="image-20230530174240127"></p>
</li>
<li><p>ä¸‹è½½å®Œæ¯•åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥è¯•ç€è¿è¡Œä¸€ä¸‹é¢„è®­ç»ƒçš„<code>ChatGLM</code>äº†ï¼Œ æ³¨æ„ï¼Œè¿™é‡Œæ ¹æ®ä½ ç”µè„‘çš„æ˜¾å­˜ä¸åŒé‡‡ç”¨çš„é‡åŒ–è§„åˆ™ä¹Ÿä¸å¤ªç›¸åŒï¼Œ å®˜ç½‘çš„å»ºè®®å¦‚ä¸‹ï¼š</p>
</li>
</ol>
<table>
<thead>
<tr>
<th><strong>é‡åŒ–ç­‰çº§</strong></th>
<th><strong>æœ€ä½ GPU æ˜¾å­˜</strong>ï¼ˆæ¨ç†ï¼‰</th>
<th><strong>æœ€ä½ GPU æ˜¾å­˜</strong>ï¼ˆé«˜æ•ˆå‚æ•°å¾®è°ƒï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>FP16ï¼ˆæ— é‡åŒ–ï¼‰</td>
<td>13 GB</td>
<td>14 GB</td>
</tr>
<tr>
<td>INT8</td>
<td>8 GB</td>
<td>9 GB</td>
</tr>
<tr>
<td>INT4</td>
<td>6 GB</td>
<td>7 GB</td>
</tr>
</tbody></table>
<p>â€‹       å¦‚æœä½ çš„ç”µè„‘æ˜¯8Gæ˜¾å­˜ï¼Œ æœ¬äººå®æµ‹ä¹Ÿåªèƒ½é€‰æ‹©<code>INT4</code> é‡åŒ–ï¼Œ å¯¹äº6Gä»¥ä¸‹æ˜¾å­˜çš„ç”¨æˆ·ä¸å¤ªå‹å¥½ï¼Œä½ è¿™é‡Œå¯ä»¥å°è¯•<a target="_blank" rel="noopener" href="https://github.com/Jittor/JittorLLMs">æ¸…åçš„å¦ä¸€ä¸ªé¡¹ç›®</a> , åŸºäº<code>åŠ¨æ€è®¡ç®—å›¾</code>çš„<code>ç¡¬ç›˜ï¼Œå†…å­˜ï¼Œæ˜¾å­˜</code>åŠ¨æ€äº¤æ¢é‡åŒ–çš„æ–¹å¼è¿›è¡Œè¿è¡Œã€‚ç¬”è€…çš„æ˜¾å¡ä¸º<code>NVIDIA RTX 3070Ti-Laptop</code>ï¼Œ æ˜¾å­˜ä¸º8Gï¼Œé€‰æ‹©ä¸º<code>INT4</code>é‡åŒ–ã€‚</p>
<p>â€‹       ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰çš„é¢„è®¾æ­¥éª¤å•¦ï¼Œç°åœ¨å¯ä»¥éƒ¨ç½²å®éªŒäº†ï¼Œ é€‰æ‹©è¿™ä¸ªæ–‡ä»¶ï¼š</p>
<p><img src="/../images/image-20230530175109292.png" alt="image-20230530175109292"></p>
<p>å°†ç¬¬7-8è¡Œçš„ä»£ç ä¿®æ”¹ä¸ºï¼š</p>
<p><code>INT4é‡åŒ–</code>ï¼š</p>
<pre><code class="python">tokenizer = AutoTokenizer.from_pretrained(&quot;chatglm-6b&quot;, trust_remote_code=True)
model = AutoModel.from_pretrained(&quot;chatglm-6b&quot;, trust_remote_code=True).quantize(4).half().cuda()
</code></pre>
<p>æˆ–è€…<code>INT8é‡åŒ–</code>:</p>
<pre><code class="python">tokenizer = AutoTokenizer.from_pretrained(&quot;chatglm-6b&quot;, trust_remote_code=True)
model = AutoModel.from_pretrained(&quot;chatglm-6b&quot;, trust_remote_code=True).quantize(8).half().cuda()
</code></pre>
<p>ç„¶åè¿›è¡Œè¿è¡Œå³å¯ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ç»™ä»–æé—®äº†ï¼Œå–å†³äºä½ çš„æ˜¾å¡çš„æ˜¾å­˜å’Œç®—åŠ›ï¼Œå›å¤é€Ÿåº¦å¯èƒ½å­˜åœ¨å·®è·ã€‚</p>
<p><img src="/../images/image-20230530183000569.png" alt="image-20230530183000569"></p>
<p><img src="/../images/image-20230530183459075.png" alt="image-20230530183459075"></p>
<h4 id="åŸºäºè‡ªå·±çš„QQæ•°æ®é›†çš„P-tuning"><a href="#åŸºäºè‡ªå·±çš„QQæ•°æ®é›†çš„P-tuning" class="headerlink" title="åŸºäºè‡ªå·±çš„QQæ•°æ®é›†çš„P-tuning"></a>åŸºäºè‡ªå·±çš„QQæ•°æ®é›†çš„P-tuning</h4><p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://github.com/kcxain/CloneLLM">kcxain</a>,çš„ä»‹ç»ï¼Œä½ ç°åœ¨åº”è¯¥èƒ½å¤Ÿå®Œæˆæ•°æ®é›†çš„æ„å»ºï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è®­ç»ƒäº†ï¼Œ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½œè€…ä½¿ç”¨çš„æ˜¯<code>Linux</code>ç³»ç»Ÿç¼–å†™çš„è®­ç»ƒè„šæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨<code>windows</code>ä¸‹è¿›è¡Œè®­ç»ƒéœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©<code>P-tuning</code>ä¸‹é¢çš„<code>main.py</code>æ–‡ä»¶</p>
<p><img src="/../images/image-20230530175722861.png" alt="image-20230530175722861"></p>
<p>åœ¨pycharmä¸­æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®å‚æ•°</p>
<p><img src="/../images/image-20230530175742124.png" alt="image-20230530175742124"></p>
<p>åœ¨è¿™é‡Œè¾“å…¥å‚æ•°ï¼š</p>
<p><img src="/../images/image-20230530175804152.png" alt="image-20230530175804152"></p>
<p>æˆ‘è¿™é‡Œé€‰æ‹©çš„å‚æ•°ä¸ºï¼š</p>
<pre><code class="bash">--quantization_bit
4
--do_train
--train_file
æˆ‘çš„å¥½å‹.txt.json
--prompt_column
prompt
--response_column
response
--history_column
history
--overwrite_cache
--model_name_or_path
..\chatglm-6b
--output_dir
chatglm_qq
--overwrite_output_dir
--max_source_length
128
--max_target_length
128
--per_device_train_batch_size
4
--per_device_eval_batch_size
1
--gradient_accumulation_steps
2
--predict_with_generate
--max_steps
10000
--logging_steps
10
--save_steps
1000
--learning_rate
0.002
--pre_seq_len
128
</code></pre>
<p>è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œæ ¹æ®ä½ çš„æ˜¾å¡çš„æ˜¾å­˜å¤§å°ï¼Œå¯ä»¥é€‚å½“è°ƒæ•´<code>batch_size</code>,<code>max_source_length</code>,<code>max_target_length  </code>ä»è€Œå‡å°ä½ çš„æ˜¾å­˜æ¶ˆè€—ï¼Œè¿™é‡Œæˆ‘è®¾ç½®çš„å‚æ•°çš„æ˜¾å­˜å ç”¨ä¸º<code>7.8/8G</code>, åŸºæœ¬ä¸Šåƒæ»¡äº†ã€‚</p>
<p><img src="/../images/image-20230530180019282.png" alt="image-20230530180019282"></p>
<p>ç„¶åæˆ‘ä»¬è¿è¡Œåä¾¿å¯ä»¥çœ‹åˆ°è®­ç»ƒçš„logè¾“å‡ºäº†ã€‚</p>
<p><img src="/../images/image-20230530180052355.png" alt="image-20230530180052355"></p>
<p>è¿™é‡Œæˆ‘è®¾ç½®çš„æ¯éš”1000ä¸ªepochè¿›è¡Œä¸€ä¸ªä¿å­˜ï¼Œåœ¨è®­ç»ƒ1000ä¸ªepochåï¼Œæˆ‘ç»ˆæ­¢äº†ã€‚è¿™æ˜¯ç›®å‰çš„å¯¹è¯æ•ˆæœï¼š</p>
<p>æŒ‰ç…§åšä¸»çš„ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯åœ¨pyç¨‹åºä¸­</p>
<pre><code class="BASH">--model_name_or_path
..\chatglm-6b
--pre_seq_len
128
--ptuning_checkpoint
chatglm_qq/checkpoint-1000
</code></pre>
<p><img src="/../images/image-20230530185103745.png" alt="image-20230530185103745"></p>
<p>å¥½å§ï¼Œçœ‹æ¥æˆ‘å’ŒQQç¾¤å‹ä¸»è¦çš„è®¨è®ºå†…å®¹è¿˜æ˜¯å…³äºæ–‡ä»¶æ¥å—&#x2F;ä¼ è¾“çš„ï¼Œ å¤ªå°´å°¬äº†ï¼Œåé¢å‡†å¤‡æ‹¿QQç¾¤èŠæ•°æ®è®­ç»ƒä¸€ä¸‹ ï¼Œæ¯•ç«Ÿæˆ‘çš„æ´»è·ƒä¸»è¦æ˜¯åœ¨QQç¾¤èŠç«‹é©¬ğŸ¤£ã€‚ </p>
<p>ç¬”è€…åˆè¿›è¡Œäº†è®­ç»ƒï¼Œå¾—åˆ°å¦‚ä¸‹æ•ˆæœï¼š</p>
<p><img src="/../images/image-20230530201939083.png" alt="image-20230530201939083"></p>
<p>æ€ä¹ˆè¯´å‘¢ï¼Œå·®å¼ºäººæ„å§ï¼Œ å¯èƒ½è¿˜æ˜¯é¢„æ–™æ•°æ®é›†è´¨é‡è¾ƒå·®ã€‚</p>
<h3 id="æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿ"><a href="#æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿ" class="headerlink" title="æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿ"></a>æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿ</h3><p>åœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬å®Œæˆäº†åŸºäºè‡ªå·±çš„QQæ•°æ®é›†çš„<code>P-tuning</code>å¾—åˆ°çš„è‡ªå·±çš„å¯¹è¯æ¨¡å‹ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥éƒ¨ç½²äº†ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨çš„æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆ<code>cqhttp+nonebot</code>, ç„¶åé€‰æ‹©åŸºäºå·²æœ‰æ’ä»¶è¿›è¡Œä¿®æ”¹å¾—åˆ°ã€‚<code>nonebot</code>æ˜¯ä¸€ä¸ªåŸºäºå¼‚æ­¥æ¶æ„æ­å»ºçš„ï¼Œ åŸºäºæ­¤ï¼Œæˆ‘ä»¬åŸºäº<code>fast api</code>æ­å»ºä¸€ä¸ªå¼‚æ­¥è·¯ç”±æ„å»ºè‡ªå·±çš„æ•°å­—å­ªç”Ÿã€‚å€ŸåŠ©<code>GPT4</code>ï¼Œç®€å•æè¿°éœ€æ±‚åä¾¿å¯ä»¥å¾—åˆ°æ‰€éœ€è¦çš„ä»£ç ï¼š</p>
<pre><code class="python">from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from transformers import (
    AutoConfig,
    AutoModel,
    AutoTokenizer,
)
from arguments import ModelArguments, DataTrainingArguments
import torch
import os

app = FastAPI()

model = None
tokenizer = None


class Prompt(BaseModel):
    text: str

@app.on_event(&quot;startup&quot;)
async def load_model():
    global model, tokenizer

    model_args = ModelArguments(
        model_name_or_path=&quot;..\\chatglm-6b&quot;,
        ptuning_checkpoint=&quot;chatglm_qq/checkpoint-600&quot;,
        pre_seq_len=128,
        prefix_projection=False,
        quantization_bit=8,
    )

    tokenizer = AutoTokenizer.from_pretrained(model_args.model_name_or_path,
                                              trust_remote_code=True)
    config = AutoConfig.from_pretrained(model_args.model_name_or_path,
                                        trust_remote_code=True)

    config.pre_seq_len = model_args.pre_seq_len
    config.prefix_projection = model_args.prefix_projection

    if model_args.ptuning_checkpoint is not None:
        print(
            f&quot;Loading prefix_encoder weight from &#123;model_args.ptuning_checkpoint&#125;&quot;
        )
        model = AutoModel.from_pretrained(model_args.model_name_or_path,
                                          config=config,
                                          trust_remote_code=True).quantize(4).half().cuda()
        prefix_state_dict = torch.load(
            os.path.join(model_args.ptuning_checkpoint, &quot;pytorch_model.bin&quot;))
        new_prefix_state_dict = &#123;&#125;
        for k, v in prefix_state_dict.items():
            if k.startswith(&quot;transformer.prefix_encoder.&quot;):
                new_prefix_state_dict[
                    k[len(&quot;transformer.prefix_encoder.&quot;):]] = v
        model.transformer.prefix_encoder.load_state_dict(new_prefix_state_dict)
    else:
        model = AutoModel.from_pretrained(model_args.model_name_or_path,
                                          config=config,
                                          trust_remote_code=True)

    if model_args.quantization_bit is not None:
        print(f&quot;Quantized to &#123;model_args.quantization_bit&#125; bit&quot;)
        model = model.quantize(model_args.quantization_bit)

    if model_args.pre_seq_len is not None:
        # P-tuning v2
        model = model.half().cuda()
        model.transformer.prefix_encoder.float().cuda()

    model = model.eval()
    print(f&quot;æ¨¡å‹åŠ è½½æˆåŠŸ&quot;)


@app.post(&quot;/chatglm/qq/ask&quot;)
async def ask(prompt: Prompt):
    global model, tokenizer
    if model is None or tokenizer is None:
        raise HTTPException(status_code=503, detail=&quot;Model not loaded&quot;)

    # ç°åœ¨ä½ éœ€è¦ä½¿ç”¨modelå’Œtokenizerå¤„ç†promptå¹¶ç”Ÿæˆresponse
    # response = model.chat(prompt)
    # è°ƒç”¨æ¨¡å‹çš„ chat æ–¹æ³•
    history = []
    response, history = model.chat(
        tokenizer,
        prompt.text,
        history=history,
    )

    return &#123;&quot;response&quot;: response&#125;



async def main():
    await load_model()
    while True:
        prompt = input(&quot;è¯·è¾“å…¥ï¼š&quot;)
        response = await ask(Prompt(text=prompt))
        print(response)


if __name__ == &quot;__main__&quot;:
    import asyncio
    asyncio.run(main())
</code></pre>
<p>å¯åŠ¨ä»£ç ä¸ºï¼š</p>
<pre><code class="bash"> uvicorn qq_chat_app:app --host 0.0.0.0 --port 1414 --reload
</code></pre>
<p>ç®€å•ç¼–å†™æµ‹è¯•ä»£ç æµ‹è¯•ç«¯å£ï¼š</p>
<pre><code class="python">import requests
def get_chatglm(prompt):
    url = &#39;http://localhost:1414/chatglm/qq/ask&#39;
    data = &#123;
        &#39;text&#39;: prompt
    &#125;
    response = requests.post(url, json=data)

    print(response.json()[&quot;response&quot;])

get_chatglm(&quot;ä½ æ˜¯è°ï¼Ÿ ä½ èƒ½å¹²ä»€ä¹ˆï¼Ÿ ä»Šå¤©æ™šä¸Šä»€ä¹ˆåƒä»€ä¹ˆï¼Ÿ&quot;)
</code></pre>
<p>å¾—åˆ°ç»“æœ:</p>
<pre><code class="bash">æˆ‘æ˜¯ä¸€ä¸ªåä¸º ChatGPT çš„äººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥é€šè¿‡è‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯ï¼Œå›ç­”æ‚¨çš„é—®é¢˜å’Œæä¾›ä¿¡æ¯ã€‚
</code></pre>
<p>æˆåŠŸæµ‹è¯•é€šæ¥å£ï¼Œæš‚æ—¶åŸºäº<code>nonebot2</code>æ­å»ºäº†ä¸€ä¸ªç®€å•çš„å›å¤æ¡†æ¶ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="/../images/image-20230530214355521.png" alt="image-20230530214355521"></p>
<p><img src="/../images/image-20230530214405417.png" alt="image-20230530214405417"></p>
<p><img src="/../images/image-20230530214524635.png" alt="image-20230530214524635"></p>
<p>ç”±äºç›®å‰<code>tx</code>å¯¹QQæœºå™¨äººé£æ§ä¸¥é‡ï¼Œå›å¤äº†å‡ æ¬¡å°±ä¸è¡Œäº†ï¼Œè€Œä¸”å›å¤æ•ˆæœåªèƒ½ç®—ä¸€èˆ¬å§ã€‚</p>
<h1 id="Todo-List"><a href="#Todo-List" class="headerlink" title="Todo List"></a>Todo List</h1><ul>
<li><input disabled type="checkbox"> ä¼˜åŒ–æ•°æ®é›†æ„å»ºï¼Œ æé«˜å¯¹è¯è´¨é‡ï¼Œå¢å¼ºæ¨¡å‹è®­ç»ƒã€‚</li>
<li><input disabled type="checkbox"> å°è¯•æ³¨å…¥<code>RWKV</code>, <code>LLM</code>ç­‰æ¨¡å‹è¿›è¡Œæ„å»ºã€‚</li>
<li><input disabled type="checkbox"> æš‚æ—¶è¿˜æ²¡æƒ³å¥½ã€‚</li>
</ul>

    </div>
    
    
    
    
    
    
    
</div>

                    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2023 LinkedList&#39;s Blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Ding Li
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>


    
        <!-- ä¸è’œå­ç»Ÿè®¡ -->
        <span id="busuanzi_container_site_pv">
                æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
        </span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv" style='display:none'>
                æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
        </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
</footer>

                </div>
            </transition>
            
            <transition name="fade">
                <div id="preview" ref="preview" v-show="previewShow">
                    <img id="preview-content" ref="previewContent" />
                </div>
            </transition>
            
        </div>
        <script src="/js/main.js"></script>
        
        




        
    </body>
</html>
